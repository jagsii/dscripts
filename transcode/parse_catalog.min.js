const URL=require("url"),hrefRecordRegex=/href=\s*['"](?<url>[^'"]+)['"][^>]*>(?<name>[^<]+)</g,hrefWrappedRecordRegex=/href=\s*['"](?<url>[^'"]+)['"][^>]*>\s*<(?:span|dd|div)[^>]*>(?<name>[^<]+)</g,selectIndexTotalPagesRegex=/\/index_(?<totalPages>\d+)\.html"[^>]*>[^<]+<\/option>\s*<\/select/,selectSlashTotalPagesRegex=/\/\d+\/(?<totalPages>\d+)\/?"[^>]*>[^<]+<\/option>\s*<\/select/;function getSelectLastOption(html,test){let pos,start=0;for(;-1!==(pos=html.indexOf("</select",start));){let optPos=html.lastIndexOf("<option",pos);if(-1===optPos)continue;let opt=html.substring(optPos,pos);if(test(opt))return opt;start=pos+8;}return null}function getSelectLastOptionSubRegex(html,regex){let pos,start=0;for(;-1!==(pos=html.indexOf("</select",start));){let optPos=html.lastIndexOf("<option",pos);if(-1===optPos)continue;let opt=html.substring(optPos,pos);const s=opt.subRegex(regex);if(s)return s;start=pos+8;}return null}function cleanTrailingDuplicate(catalog){if(2>catalog.length)return catalog;let count=0;const lastId=catalog.last.id;for(let i=catalog.length-2;-1<i;i--){if(catalog[i].id===lastId){count++;continue}break}return 0<count&&catalog.splice(catalog.length-count,count),catalog}function cleanDescendingNewest(catalog){if(2>catalog.length)return catalog;let since=-1;for(let i=1;i<catalog.length;i++)catalog[i].id<catalog[i-1].id&&(since=i);return -1===since?catalog:catalog.slice(since)}function cleanNewest(catalog){var _Mathmin=Math.min;if(0===catalog.length)return catalog;let since=-1;const maxCheck=_Mathmin(17,catalog.length);if(!catalog.first.volume){for(let i=0;i<maxCheck;i++)if(catalog[i].id!==catalog[catalog.length-1-i].id){since=i;break}}else for(let i=0;i<maxCheck;i++)if(catalog[i].volume&&!/最新(.+章|章[节節])/.test(catalog[i].volume)){since=i;break}return 0<since&&catalog.splice(0,since),catalog}function cleanCatalogWrapper(html,identity,trailing,index){let matcher,regex=identity instanceof RegExp?identity:new RegExp(`(?:id|class)="${identity}"[^>]*>`);if(index!==void 0){regex.global||(regex=new RegExp(regex,"g"));const matchers=html.matchAll(regex);let i=1;const matchersArray=[];for(const m of matchers){if(i++===index){matcher=m;break}matchersArray.push(m);}0>index&&(matcher=matchersArray[matchersArray.length+index]);}else matcher=regex.exec(html);if(matcher){html=html.substring(matcher.index+matcher[0].length);let trailingIndex=-1;if(trailing){if(trailing instanceof RegExp){const m=trailing.exec(html);m&&(trailingIndex=m.index);}else trailingIndex=html.indexOf(trailing);-1!==trailingIndex&&(html=html.substring(0,trailingIndex));}}return html}function removeNewestChapters(html){let m=/<dt>\s*(<b>)?《[^》]+》(最新章[节節]|[^<]+启用缓存)/.exec(html);return m?html=html.substring(html.indexOf("<dt>",m.index+5)).subIndexOf("</a></dt>"):(m=/章[节節]目[录錄]<\/dt>/.exec(html),m&&(html=html.substring(m.index))),html}function parseRegex(regex){if(regex instanceof Array){let _regex=regex[1];-1===_regex.flags.indexOf("g")&&(_regex=RegExp(_regex,"g"));const result={fragmentRegex:regex[0]instanceof RegExp?regex[0]:regex[0].pattern,fragmentIndex:regex[0]instanceof RegExp?void 0:regex[0].index,recordRegex:_regex};return 2<regex.length&&(result.postProcessor=regex[2]),result}if("div.mulu+dl>(dt,dd)"===regex)return {recordRegex:/<dt>(?<volume>[^<]+)<\/dt>|<dd>\s*<[aA] [^>]*href=\s*["'](?<url>[^"']+)["'][^>]*>(?<name>[^<]+)</g,cleaner:html=>(html=cleanCatalogWrapper(html,"mulu","</dl>"),html)};if("listmain>dl>dd"===regex)return {recordRegex:/<dd>\s*<[aA] [^>]*href\s*=["'](?<url>[^"']+)["'][^>]*>(?<name>[^<]+)</g,cleaner:html=>(html=removeNewestChapters(cleanCatalogWrapper(html,"listmain","</dl>")),html)};if("listmain>dl>(dt,dd)"===regex)return {recordRegex:/<dt[^>]*>《[^》]*》(?<volume>[^<]+)<\/dt>|<dd>\s*<[aA] [^>]*href\s*=["'](?<url>[^"']+)["'][^>]*>(?<name>[^<]+)</g,cleaner:html=>(html=cleanCatalogWrapper(html,"listmain","</dl>"),html)};if("div#list>dl>(dt,dd)"===regex)return {recordRegex:/<dt[^>]*>(?:\s*(?:<b>)?[^<]+<\/b>)?(?<volume>[^<]+)<\/dt>|<dd>\s*<[aA] [^>]*href\s*=["'](?<url>[^"']+)["'][^>]*>(?<name>[^<]+)</g,cleaner:html=>(html=removeNewestChapters(cleanCatalogWrapper(html,"list","</dl>")),html)};if("div#list>dl>(dt>b,dd)"===regex)return {recordRegex:/(?<since><dt>\s*<b>(?:《[^》]+》)?\s*(?<volume>[^<]+)<\/b>)|<dd>\s*<[aA] [^>]*href\s*=["'](?<url>[^"']+)["'][^>]*>(?<name>[^<]+)</g,cleaner:html=>(html=removeNewestChapters(cleanCatalogWrapper(html,"list","</dl>")),html)};if("div#list>dl>dd"===regex)return {recordRegex:/href\s*=["'](?<url>[^"']+)["'][^>]*>(?:\s*<dd>)?(?<name>[^<]*)(?:<\/dd>\s*)?</g,cleaner:html=>(html=removeNewestChapters(cleanCatalogWrapper(html.replace(/<dl><\/dl>/g,""),"list","</dl>")).replace(/<dt>(?:\s*<\w+[^>]*>[^<]*<\/\w+>)+\s*<\/dt>/g,""),html)};if("div#list>ul>li"===regex)return {recordRegex:hrefRecordRegex,cleaner:html=>cleanCatalogWrapper(html,"list","</ul>")};if("div#list@last>dl>dd"===regex)return {recordRegex:/<dd>\s*<a[^>]* href\s*=["'](?<url>[^"']+)["'][^>]*>(?<name>[^<]*)</g,cleaner:html=>(html=cleanCatalogWrapper(html,"list","</dl>",-1),html)};if(".section-list"===regex)return {recordRegex:hrefRecordRegex,cleaner:html=>cleanCatalogWrapper(html,/section-list[^"]*"[^>]*>/,/<\/(ul|div)>/,-1)};if("dl.zjlist"===regex)return {recordRegex:/href\s*=['"](?<url>[^'"]+)['"][^>]*>(?<name>[^<]+)<|<h[2345]>(?<volume>[^<]+)</g,cleaner:html=>cleanCatalogWrapper(html,/class="zjlist[^"]*"[^>]*>/,"</dl>")};if("table#at"===regex)return {recordRegex:hrefRecordRegex,cleaner:html=>cleanCatalogWrapper(html,/id="at"[^>]*>/,"</table>",-1)};if("dl.panel-chapterlist"===regex)return {recordRegex:hrefRecordRegex,cleaner:html=>cleanCatalogWrapper(html,/panel-chapter[lL]ist[^>]+>/g,"</dl>",-1)};if("#list-chapterAll dl"===regex)return {recordRegex:hrefRecordRegex,cleaner:html=>cleanCatalogWrapper(html,/id="list-chapterAll"/,"</dl>")};if("ul.chapterlist"===regex)return {recordRegex:hrefRecordRegex,cleaner:html=>cleanCatalogWrapper(html,/class="chapter[lL]ist[^"]*"[^>]*>/g,"</ul>",-1)};if("ul#chapterlist"===regex)return {recordRegex:hrefRecordRegex,cleaner:html=>cleanCatalogWrapper(html,/id="chapter[lL]ist"[^>]*>/g,"</ul>",-1)};if(".index>(.volume,ul.chapters)"===regex)return {recordRegex:/href\s*="(?<url>[^"]+)"[^>]*>(?<name>[^<]+)<|class="volume"[^>]*>\s*\S+ (?<volume>[^<]+)</g,cleaner:html=>cleanCatalogWrapper(html,/class="index"[^>]*>/,/<\/ul>\s*<\/div>/,-1)};if("ul.chapters"===regex)return {recordRegex:hrefRecordRegex,cleaner:html=>cleanCatalogWrapper(html,/class="chapters"[^>]*>/g,"</ul>")};if("\u4E0B\u62C9\u5F0F\u9605\u8BFB"===regex)return {fragmentRegex:/<ul id="chapter-list-[^>]*>(?<fragment>(?:\s*<li>\s*<a[^>]*>\s*<span>[^<]*<\/span>\s*<\/a>\s*<\/li>)+)/,recordRegex:/href\s*="(?<url>[^"]+\d+\.html)"[^>]*>\s*<span>(?<name>[^<]+)</g};if("jieqi230"===regex)return {fragmentRegex:/<div class="index">\s*(?<fragment>(?:\s*<div class="volume">[^<]*<\/div>|\s*<\/?ul[^>]*>|\s*<li[^>]*>\s*<a[^>]*>[^<]*<\/a>\s*<\/li>)+)/,recordRegex:/volume">\s*(?:[^<\s]+\s)?(?<volume>[^<]+)|href\s*=["'](?<url>[^"']+)["'][^>]*>(?<name>[^<]+)/g};if(".pt-chapter"===regex)return {cleaner:html=>cleanCatalogWrapper(html,/class="pt-chapter-cont-detail[^"]+full/,"</div>"),recordRegex:hrefRecordRegex};if("div.ml_list"===regex)return {cleaner:html=>cleanCatalogWrapper(html,/class="ml_list"/,"</div>"),recordRegex:hrefRecordRegex};if(regex.hasOwnProperty("recordRegex"))return regex;throw new Error(`unknown ParseCatalog regex ${regex}`)}async function collect(html,regex,url,options){null!=options.preprocess&&(html=await options.preprocess(html));const uri="string"==typeof url?new URL(url):url,buildUrl=null!=options.urlBuilder;let catalog;if(options.parser)catalog=await options.parser(html),catalog.forEach(_=>{_.url=buildUrl?options.urlBuilder(_.id):uri.resolve(_.url.trim());});else {stat("parseRegex");const htmlParser=parseRegex(regex);stat("parseRegex");const hasVolume=-1!==htmlParser.recordRegex.source.indexOf("?<volume>"),_idRegexp=options.idRegex||/(?<id>\d+)(?:\.s?html?|\/$)/;let volumeRegex,skip=-1!==htmlParser.recordRegex.source.indexOf("?<skip>"),since=-1!==htmlParser.recordRegex.source.indexOf("?<since>");hasVolume&&(options.hasOwnProperty("volumeRegex")&&null==options.volumeRegex?volumeRegex=null:volumeRegex=options.volumeRegex||/(?:《[^》]*》)?\s*(?<volume>.+)\s*/);let fragment;if(stat("fragment"),null===htmlParser.fragmentRegex||void 0===htmlParser.fragmentRegex)fragment=html;else if(void 0===htmlParser.fragmentIndex)fragment=htmlParser.fragmentRegex.exec(html).groups.fragment;else {const _=[...html.matchAll(htmlParser.fragmentRegex)];fragment=_[0>htmlParser.fragmentIndex?_.length+htmlParser.fragmentIndex:htmlParser.fragmentIndex][1];}if(null!=htmlParser.cleaner&&(fragment=htmlParser.cleaner(fragment)),stat("fragment"),null!=options.transformer){stat("transformer");const _=options.transformer(fragment);fragment=_ instanceof Promise?await _:_,stat("transformer");}stat("matchAll");const matches=fragment.matchAll(htmlParser.recordRegex);stat("matchAll");let volume=null;catalog=[],stat("collect");for(let match of matches){if(skip){if(null==match.groups.skip)continue;skip=!1;continue}if(since){if(null==match.groups.since)continue;since=!1;}if(hasVolume&&null!=match.groups.volume){volume=match.groups.volume,null!=volumeRegex&&(volume="function"==typeof volumeRegex?volumeRegex(volume):volumeRegex.exec(volume).groups.volume.trim()),(-1!==["\u6B63\u6587","\u6B63\u6587\u5377"].indexOf(volume)||volume?.endsWith("\u7AE0\u8282\u76EE\u5F55"))&&(volume=null);continue}if(null==match.groups.ignore)if(null!=match.groups.name){let cid;const _url=match.groups.url?.trim();if(match.groups.id)cid=match.groups.id;else if("function"==typeof _idRegexp)cid=_idRegexp(_url);else {const idMatch=_idRegexp.exec(_url);if(!idMatch)continue;cid=idMatch.groups.id;}const record={id:cid,name:match.groups.name,url:buildUrl?options.urlBuilder(cid):uri.resolve(_url)};hasVolume&&void 0!==volume&&null!==volume&&(record.volume=volume),catalog.push(record);}else if(null!=match.groups.hidden){const record={id:"",name:match.groups.hidden,url:""};hasVolume&&void 0!==volume&&null!==volume&&(record.volume=volume),catalog.push(record);}}if(null!=htmlParser.postProcessor)return htmlParser.postProcessor(catalog)}return cleanNewest(catalog),stat("collect"),catalog}async function parseCatalog(url,regex,options){options=options||{};let html;const clientOptions={encoding:"utf-8",...options.clientOptions};if(options.webview){const webviewFetch=require("webview_fetch");html=await webviewFetch(url,{mobile:1===clientOptions["x-mobile"],...options.webviewOptions});}else {const httpOptions={url,...options.httpOptions};options.lvt&&(!httpOptions.headers&&(httpOptions.headers={}),httpOptions.headers={cookie:lvtCookie(options.lvt)});const{send}=require("http");stat("request");let response=await send(httpOptions,clientOptions);if(stat("request"),options.onBlocked&&isBlocked(response))return await options.onBlocked().then(_=>!0===options.reverse?_.reverse():_).then(_=>formatCatalog(_));if(null!=options.retry&&(response=await handleRequestRetry(response,httpOptions,clientOptions,send,options.retry)),options.fallbackToWebview&&options.fallbackToWebview(response)){const webviewFetch=require("webview_fetch");html=await webviewFetch(url,{mobile:1===clientOptions["x-mobile"],...options.webviewOptions});}else assertOK(response),html=response.body;}return await collect(html,regex,url,options).then(_=>!0===options.reverse?_.reverse():_).then(_=>formatCatalog(_))}async function parseCatalogPaginate(urlGenerator,regex,options){const pageSize=options.pageSize||20,totalPagesOffset=null==options.totalPagesOffset?0:options.totalPagesOffset;let fetchLast,page=options.page,chapterIndex=options.chapterIndex;-1===page?(fetchLast=!0,page=null):fetchLast=!1,null==page&&(null==chapterIndex?page=1:page=Math.floor(chapterIndex/pageSize)+1),1>page&&(page=1),fetchLast&&options.totalPagesTryPage!==void 0&&(page=Math.max(options.totalPagesTryPage,page));let url=urlGenerator(page);const httpOptions={url,...options.httpOptions};options.lvt&&(!httpOptions.headers&&(httpOptions.headers={}),httpOptions.headers={cookie:lvtCookie(options.lvt)});const clientOptions={encoding:"utf-8",...options.clientOptions};let html;if(options.webview){const webviewFetch=require("webview_fetch");html=await webviewFetch(url,{mobile:1===clientOptions["x-mobile"],...options.webviewOptions});}else {const{send}=require("http");stat("request");let response=await send(httpOptions,clientOptions);if(stat("request"),options.onBlocked&&isBlocked(response))return await options.onBlocked().then(_=>formatCatalog(_));if(null!=options.retry&&(response=await handleRequestRetry(response,httpOptions,clientOptions,send,options.retry)),options.fallbackToWebview&&options.fallbackToWebview(response)){const webviewFetch=require("webview_fetch");html=await webviewFetch(url,{mobile:1===clientOptions["x-mobile"],...options.webviewOptions});}else assertOK(response),html=response.body;}let totalPages;if("function"==typeof options.totalPagesRegex)totalPages=options.totalPagesRegex(html);else {const totalPagesMatch=options.totalPagesRegex.exec(html);totalPages=totalPagesMatch?parseInt(totalPagesMatch.groups.totalPages)+totalPagesOffset:1;}if(fetchLast&&totalPages>page||totalPages<page)if(page=totalPages,url=urlGenerator(page),options.webview){const webviewFetch=require("webview_fetch");html=await webviewFetch(url,{mobile:1===clientOptions["x-mobile"],...options.webviewOptions});}else {const{send}=require("http");stat("request");let response=await send({...httpOptions,url},clientOptions);if(stat("request"),options.fallbackToWebview&&options.fallbackToWebview(response)){const webviewFetch=require("webview_fetch");html=await webviewFetch(url,{mobile:1===clientOptions["x-mobile"],...options.webviewOptions});}else assertOK(response),html=response.body;}const catalog=await collect(html,regex,url,options).then(_=>!0===options.reverse?_.reverse():_).then(_=>formatCatalog(_));return {paginate:{pageNo:page,pageSize,totalPages},catalog}}function reorderVerticalDoubleGroup(catalog,cols){const group=2*cols;for(let i=0;i<catalog.length;i+=group){const end=Math.min(catalog.length,i+group),c=end-i-cols;if(end-i>cols)for(let j=0;j<c;j++)catalog[i+2*j+1].order=i+group-(cols-j);let o=i;for(let j=i;j<end;j++)void 0===catalog[j].order&&(catalog[j].order=o++);}return catalog.sort((a,b)=>a.order-b.order).map(_=>(delete _.order,_))}function reorderByGroup(catalog,cols){for(let i=0;i<catalog.length;i+=4){const start=i,end=Math.min(i+3,catalog.length-1);for(let j=0;j<cols/2;j++){const s=start+j,e=end-j;if(s<e){const tmp=catalog[s];catalog[s]=catalog[e],catalog[e]=tmp;}}}return catalog}exports.collect=collect,exports.cleanNewest=cleanNewest,exports.cleanDescendingNewest=cleanDescendingNewest,exports.cleanTrailingDuplicate=cleanTrailingDuplicate,exports.parseCatalog=parseCatalog,exports.parseCatalogPaginate=parseCatalogPaginate,exports.cleanCatalogWrapper=cleanCatalogWrapper,exports.reorderVerticalDoubleGroup=reorderVerticalDoubleGroup,exports.reorderByGroup=reorderByGroup,exports.hrefRecordRegex=hrefRecordRegex,exports.hrefWrappedRecordRegex=hrefWrappedRecordRegex,exports.selectIndexTotalPagesRegex=selectIndexTotalPagesRegex,exports.selectSlashTotalPagesRegex=selectSlashTotalPagesRegex,exports.getSelectLastOption=getSelectLastOption,exports.getSelectLastOptionSubRegex=getSelectLastOptionSubRegex;