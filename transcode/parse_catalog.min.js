const absoluteUrl=require("utils/absolute_url");function cleanTrailingDuplicate(a){if(2>a.length)return a;let b=0;const c=a.last.id;for(let d=a.length-2;-1<d;d--){if(a[d].id===c){b++;continue}break}return 0<b&&a.splice(a.length-b,b),a}function cleanDescendingNewest(a){if(2>a.length)return a;let b=-1;for(let c=1;c<a.length;c++)a[c].id<a[c-1].id&&(b=c);return -1===b?a:a.slice(b)}function cleanNewest(a){var b=Math.min;if(0===a.length)return a;let c=-1;const d=b(17,a.length);if(!a.first.volume){for(let b=0;b<d;b++)if(a[b].id!==a[a.length-1-b].id){c=b;break}}else for(let b=0;b<d;b++)if(a[b].volume&&/最新(.+章|章节)/.test(a[b].volume)){c=b;break}return 0<c&&a.splice(0,c),a}function cleanCatalogWrapper(a,b,c,d){let e,f=b instanceof RegExp?b:new RegExp(`(?:id|class)="${b}"[^>]*>`);if(d!==void 0){f.global||(f=new RegExp(f,"g"));const b=a.matchAll(f);let c=1;const g=[];for(const a of b){if(c++===d){e=a;break}g.push(a);}0>d&&(e=g[g.length+d]);}else e=f.exec(a);if(e){a=a.substring(e.index+e[0].length);let b=-1;if(c){if(c instanceof RegExp){const d=c.exec(a);d&&(b=d.index);}else b=a.indexOf(c);-1!==b&&(a=a.substring(0,b));}}return a}function parseRegex(a){if(a instanceof Array){let b=a[1];-1===b.flags.indexOf("g")&&(b=RegExp(b,"g"));const c={fragmentRegex:a[0]instanceof RegExp?a[0]:a[0].pattern,fragmentIndex:a[0]instanceof RegExp?void 0:a[0].index,recordRegex:b};return 2<a.length&&(c.postProcessor=a[2]),c}if("div.mulu+dl>(dt,dd)"===a)return {recordRegex:/<dt>(?<volume>[^<]+)<\/dt>|<dd>\s*<a href=["'](?<url>[^"']+)["'][^>]*>(?<name>[^<]+)<\/a>\s*<\/dd>/g,cleaner:a=>(a=cleanCatalogWrapper(a,"mulu","</dl>"),a)};if("div#list>dl>(dt,dd)"===a)return {recordRegex:/<dt[^>]*>(?:\s*(?:<b>)?[^<]+<\/b>)?(?<volume>[^<]+)<\/dt>|<dd>\s*<a[^>]* href\s*=["'](?<url>[^"']+)["'][^>]*>(?<name>[^<]+)<\/a>\s*<\/dd>/g,cleaner:a=>(a=cleanCatalogWrapper(a,"list","</dl>"),a)};if("listmain>dl>dd"===a)return {recordRegex:/<dd>\s*<a href\s*=["'](?<url>[^"']+)["'][^>]*>(?<name>[^<]+)<\/a>\s*<\/dd>/g,cleaner:a=>(a=cleanCatalogWrapper(a,"listmain","</dl>"),a)};if("listmain>dl>(dt,dd)"===a)return {recordRegex:/<dt[^>]*>《[^》]*》(?<volume>[^<]+)<\/dt>|<dd>\s*<a[^>]* href\s*=["'](?<url>[^"']+)["'][^>]*>(?<name>[^<]+)<\/a>\s*<\/dd>/g,cleaner:a=>(a=cleanCatalogWrapper(a,"listmain","</dl>"),a)};if("div#list>dl>(dt>b,dd)"===a)return {recordRegex:/(?<since><dt>\s*<b>(?:《[^》]+》)?\s*(?<volume>[^<]+)<\/b>)|<dd>\s*<a href\s*=["'](?<url>[^"']+)["'][^>]*>(?<name>[^<]+)<\/a>\s*<\/dd>/g,cleaner:a=>(a=cleanCatalogWrapper(a,"list","</dl>"),a)};if("div#list>dl>dd"===a)return {recordRegex:/<dd>\s*<a[^>]* href=["'](?<url>[^"']+)["'][^>]*>(?<name>[^<]*)<\/a>\s*<\/dd>/g,cleaner:a=>(a=cleanCatalogWrapper(a,"list","</dl>"),a)};if("div#list>dl>dd@last"===a)return {fragmentIndex:-1,recordRegex:/<dd>\s*<a[^>]* href=["'](?<url>[^"']+)["'][^>]*>(?<name>[^<]*)<\/a>\s*<\/dd>/g,cleaner:a=>(a=cleanCatalogWrapper(a,"list","</dl>"),a)};if(".section-list"===a)return {recordRegex:/<a [^>]*href=["'](?<url>[^"']+)["'][^>]*>(?<name>[^<]+)</g,cleaner:a=>cleanCatalogWrapper(a,/class="section-list[^"]*"[^>]*>/,"</ul>",-1)};if(".chapters"===a)return {recordRegex:/href="(?<url>[^"]+)"[^>]*>(?<name>[^<]+)<|class="volume"[^>]*>\s*\S+ (?<volume>[^<]+)</g,cleaner:a=>cleanCatalogWrapper(a,/class="index"[^>]*>/,/<\/ul>\s*<\/div>/,-1)};if("\u4E0B\u62C9\u5F0F\u9605\u8BFB"===a)return {fragmentRegex:/<ul id="chapter-list-[^>]*>(?<fragment>(?:\s*<li>\s*<a[^>]*>\s*<span>[^<]*<\/span>\s*<\/a>\s*<\/li>)+)/,recordRegex:/href="(?<url>[^"]+\d+\.html)"[^>]*>\s*<span>(?<name>[^<]+)</g};if("jieqi230"===a)return {fragmentRegex:/<div class="index">\s*(?<fragment>(?:\s*<div class="volume">[^<]*<\/div>|\s*<\/?ul[^>]*>|\s*<li[^>]*>\s*<a[^>]*>[^<]*<\/a>\s*<\/li>)+)/,recordRegex:/volume">\s*(?:[^<\s]+\s)?(?<volume>[^<]+)|href=["'](?<url>[^"']+)["'][^>]*>(?<name>[^<]+)/g};if(a.hasOwnProperty("recordRegex"))return a;throw new Error(`unknown ParseCatalog regex ${a}`)}async function collect(a,b,c,d){null!=d.preprocess&&(a=d.preprocess(a));const e=null!=d.urlBuilder;let f;if(d.parser)f=await d.parser(a),f.forEach(a=>{a.url=e?d.urlBuilder(a.id):absoluteUrl(a.url,c);});else {stat("parseRegex");const g=parseRegex(b);stat("parseRegex");const h=-1!==g.recordRegex.source.indexOf("?<volume>"),i=d.idRegex||/(?<id>\d+)(?:\.s?html?|\/$)/;let j,k=-1!==g.recordRegex.source.indexOf("?<skip>"),l=-1!==g.recordRegex.source.indexOf("?<since>");h&&(d.hasOwnProperty("volumeRegex")&&null==d.volumeRegex?j=null:j=d.volumeRegex||/(?:《[^》]*》)?\s*(?<volume>.+)\s*/);let m;if(stat("fragment"),null===g.fragmentRegex||void 0===g.fragmentRegex)m=a;else if(void 0===g.fragmentIndex)m=g.fragmentRegex.exec(a).groups.fragment;else {const b=[...a.matchAll(g.fragmentRegex)];m=b[0>g.fragmentIndex?b.length+g.fragmentIndex:g.fragmentIndex][1];}if(null!=g.cleaner&&(m=g.cleaner(m)),stat("fragment"),null!=d.transformer){stat("transformer");const a=d.transformer(m);m=a instanceof Promise?await a:a,stat("transformer");}stat("matchAll");const n=m.matchAll(g.recordRegex);stat("matchAll");let o=null;f=[],stat("collect");for(let a of n){if(k){if(null==a.groups.skip)continue;k=!1;continue}if(l){if(null==a.groups.since)continue;l=!1;}if(h&&null!=a.groups.volume){o=a.groups.volume,null!=j&&(o=j.exec(o).groups.volume.trim());continue}if(null!=a.groups.name){const b=i.exec(a.groups.url);if(!b)continue;const g=b.groups.id,j={id:g,name:a.groups.name,url:e?d.urlBuilder(g):absoluteUrl(a.groups.url,c)};h&&void 0!==o&&null!==o&&(j.volume=o),f.push(j);}}if(null!=g.postProcessor)return g.postProcessor(f)}return cleanNewest(f),stat("collect"),f}async function parseCatalog(a,b,c){c=c||{};let d;const e={encoding:"utf-8",...c.clientOptions};if(c.webview){const b=require("webview_fetch");d=await b(a,{mobile:1===e["x-mobile"]});}else {const b={url:a,...c.httpOptions},{send:f}=require("http");stat("request");let g=await f(b,e);if(stat("request"),c.onBlocked&&isBlocked(g))return await c.onBlocked();if(null!=c.retry&&(g=await handleRequestRetry(g,b,e,f)),c.fallbackToWebview&&c.fallbackToWebview(g)){const b=require("webview_fetch");d=await b(a,{mobile:1===e["x-mobile"]});}else assertOK(g),d=g.body;}return await collect(d,b,a,c)}async function parseCatalogPaginate(a,b,c){const d=c.pageSize||20,e=null==c.totalPagesOffset?0:c.totalPagesOffset;let f,g=c.page,h=c.chapterIndex;-1===g?(f=!0,g=null):f=!1,null==g&&(null==h?g=1:g=Math.floor(h/d)+1),1>g&&(g=1),f&&c.totalPagesTryPage!==void 0&&(g=Math.max(c.totalPagesTryPage,g));let i=a(g);const j={url:i,...c.httpOptions},k={encoding:"utf-8",...c.clientOptions};let l;if(c.webview){const a=require("webview_fetch");l=await a(i,{mobile:1===k["x-mobile"]});}else {const{send:a}=require("http");stat("request");let b=await a(j,k);if(stat("request"),c.onBlocked&&isBlocked(b))return await c.onBlocked();if(null!=c.retry&&(b=await handleRequestRetry(b,j,k,a)),c.fallbackToWebview&&c.fallbackToWebview(b)){const a=require("webview_fetch");l=await a(i,{mobile:1===k["x-mobile"]});}else assertOK(b),l=b.body;}let m;if("function"==typeof c.totalPagesRegex)m=c.totalPagesRegex(l);else {const a=c.totalPagesRegex.exec(l);m=a?parseInt(a.groups.totalPages)+e:1;}if(f&&m>g||m<g)if(g=m,i=a(g),c.webview){const a=require("webview_fetch");l=await a(i,{mobile:1===k["x-mobile"]});}else {const{send:a}=require("http");stat("request");let b=await a({...j,url:i},k);if(stat("request"),c.fallbackToWebview&&c.fallbackToWebview(b)){const a=require("webview_fetch");l=await a(i,{mobile:1===k["x-mobile"]});}else assertOK(b),l=b.body;}const n=await collect(l,b,i,c);return {paginate:{pageNo:g,pageSize:d,totalPages:m},catalog:n}}exports.collect=collect,exports.cleanNewest=cleanNewest,exports.cleanDescendingNewest=cleanDescendingNewest,exports.cleanTrailingDuplicate=cleanTrailingDuplicate,exports.parseCatalog=parseCatalog,exports.parseCatalogPaginate=parseCatalogPaginate,exports.cleanCatalogWrapper=cleanCatalogWrapper;