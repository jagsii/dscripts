const metaPattern=[/meta [^>]*(?:property|name)="og:novel:book_(?:name|title)"\s+content="(?<name>[^"]+)"/,/meta [^>]*(?:property|name)="og:novel:author"\s+content="(?<author>[^"]+)"/,/meta [^>]*(?:property|name)="og:novel:status"\s+content="(?<serial>[^"]+)"/,/meta [^>]*(?:property|name)="og:image"\s+content="(?<cover>[^"]+)"/,/meta [^>]*(?:property|name)="og:description"\s+content="(?<intro>[^"]+)"/],strongAIntroPattern=/>简介[:：](?:[^<]*(?:<strong[^>]*>)?<a[^>]*>[^<]*<\/a>(?:<\/strong>)?)*(?<intro>[^<>]+)</,introInfoRegex=/class="intro_info"[^>]*>(?<intro>(?:[^<]+|<br\s*\/?>|<\/?p[^>]*>)+)</;async function parseInfo(originName,url,regex,options){options=options||{};const clientOptions={encoding:"utf-8","x-mobile":1,...options.clientOptions},absoluteUrl=require("utils/absolute_url");let html;if(options.webview){const webviewFetch=require("webview_fetch");html=await webviewFetch(url,{mobile:1===clientOptions["x-mobile"],...options.webviewOptions});}else {const httpOptions={url,...options.httpOptions};options.lvt&&(!httpOptions.headers&&(httpOptions.headers={}),httpOptions.headers={cookie:lvtCookie(options.lvt)});const{send}=require("http");stat("request");let response=await send(httpOptions,clientOptions);if(stat("request"),options.onBlocked&&isBlocked(response))return options.onBlocked().then(formatInfo);if(null!=options.retry&&(response=await handleRequestRetry(response,httpOptions,clientOptions,send,options.retry)),options.fallbackToWebview&&options.fallbackToWebview(response)){const webviewFetch=require("webview_fetch");html=await webviewFetch(url,{mobile:1===clientOptions["x-mobile"],...options.webviewOptions});}else assertOK(response),html=response.body;}null!=options.preprocess&&(html=await options.preprocess(html));const result={url,originName,name:"",author:"",cover:"",serial:0,intro:""};if(options.parser)await options.parser(html,result);else {let _regex;if("string"!=typeof regex)_regex=regex;else if("Synopsis"===regex)_regex=[/<span class="title">(?<name>[^<]*)</,/synopsisArea_detail">[\S\s]+?<img src="(?<cover>[^"]*)"/,/作者：(?:<a[^>]*>)?(?<author>[^<]*)</,/class="author">(?:作者：|<a[^>]*>)+(?<author>[^<]*)</,/状态：(?<serial>[^<]*)</,/class="review">(?<intro>[^<]*)</];else if("block_txt2"===regex)_regex=[/class="block_img2">(?:\s*<script[^>]*>([^<]|<[^\/])*<\/script>)*(\s*<a[^>]+>)?\s*<img [^>]*src="(?<cover>[^"]*)"/,/<div class="block_txt2">\s*(?:<p[^>]*>)?\s*(?:<a[^>]*>)?\s*<h[12]>\s*(?:<a[^>]*>)?(?<name>[^<]+)<|书名：<a[^>]*>(?<name2>[^<]+)</,/<p>(?:作|亻乍)[者家]：(?:<a[^>]*>)?(?<author>[^<]*)/,/<p>状态：(?<serial>[^<]*)<\/p>/,introInfoRegex];else if("meta"===regex)_regex=metaPattern;else if("dd_box"===regex)_regex=/<div class="cover">\s*<img src="(?<cover>[^"]*)"[\S\s]+?<dt class="name">(?<name>[^<]+)<\/dt>\s*<dd class="dd_box">\s*<span>作者：(?<author>[^<]+)<[\S\s]+?<dd class="dd_box">\s*<span>状态：(?<serial>[^<]*)<[\S\s]+?<dt>(?:内容|手机)简介<\/dt>\s*<dd>(?<intro>[^<]*)/;else if("xsfm"===regex)_regex=[/class="xsfm"[^>]*>\s*<img [^>]*src="(?<cover>[^"]*)"[^>]*>\s*<\/div>\s*<div class="xx">\s*<ul>\s*<li>(?<name>[^<]+)<\/li>\s*<li>分类：(?:<a[^>]*>)?[^<]*(?:<\/a>)?\s*<\/li>\s*<li>作者：(?:<a[^>]*>)?(?<author>[^<]*)</,/class="jianjie[^>]+>(?<intro>(?:[^<]|<br\s*\/?>|<\/?p>)+)</];else if("infotype"===regex)_regex=[/<h[31]>(?:\s*<a[^>]+>)?(?<name>[^<]+)</,/class="infotype">\s*<p>作者：(?:<a[^>]*>)?(?<author>[^<]+)</,/class="pic">\s*<img [^>]*src="(?<cover>[^"]+)"/,/class="intro">(?:\s*<span>本书简介：<\/span>)?(?<intro>(?:\s*<\/?p>|[^<])+)</];else if("panel-body"===regex)_regex=[/h1[^>]*>(?<name>[^<]+)<\/h1>\s*<p class="booktag">\s*<a[^>]+>(?<author>[^<]*)</,/class="img-thumbnail" [^>]*src="(?<cover>[^"]+)"/,/span class="blue">(?<serial>[^<]+)</,/id="bookIntro"[^>]*>(?<intro>(?:[^<]|<br\s*\/?>)+)</];else if(".main>.detail"===regex)_regex=[/class="detail">\s*<img [^>]*src="(?<cover>[^"]*)"[^>]*>\s*<p class="name">\s*(?:<strong>)?(?<name>[^<]+)(?:<\/strong>)?\s*<\/p>\s*<p class="author">作者：<a[^>]+>(?<author>[^<]*)</,/layui-btn-danger">(?<serial>[^<]+)</,/class="intro">(?<intro>(?:[^<]|<br\s*\/?>|<\/?p>)+)</];else if(".introduce"===regex)_regex=[/class="pic">\s*<img [^>]*src="(?<cover>[^"]+)"/,/<h1>(?<name>[^<]+)<\/h1>/,/作者：<a[^>]*>(?<author>[^<]+)<\/a>\s*<\/span><span>状态：(?<serial>[^<]*)</,/class="jj"[^>]*>(?<intro>[^<]+)</];else if("cctxt"===regex)_regex=[...metaPattern,/class="intro"[^>]*>(?<intro>[^<]+)</];else throw new Error(`unknown ParseInfo regex ${regex}`);const serialChar=options.serialChar||/[完全]/;if(stat("collect"),_regex instanceof Array){const matches={};for(let re of _regex)Object.assign(matches,html.subRegexMap(re));void 0===matches.name?void 0!==matches.name2&&(result.name=matches.name2):result.name=matches.name,void 0!==matches.author&&(result.author=matches.author),void 0!==matches.cover&&(result.cover=absoluteUrl(matches.cover.trim(),url)),void 0!==matches.serial&&(result.serial=("string"==typeof serialChar?-1!==matches.serial.indexOf(serialChar):serialChar.test(matches.serial))?1:0),void 0!==matches.intro&&(result.intro=matches.intro);}else if(-1===_regex.flags.indexOf("g")){stat("match");const m=_regex.exec(html);if(stat("match"),null==m)return null;void 0===m.groups.name?void 0!==m.groups.name2&&(result.name=m.groups.name2):result.name=m.groups.name,void 0!==m.groups.author&&(result.author=m.groups.author),void 0!==m.groups.cover&&(result.cover=absoluteUrl(m.groups.cover.trim(),url)),void 0!==m.groups.serial&&(result.serial=("string"==typeof serialChar?-1!==m.groups.serial.indexOf(serialChar):serialChar.test(m.groups.serial))?1:0),void 0!==m.groups.intro&&(result.intro=m.groups.intro);}else {stat("matchAll");const matches=html.matchAll(_regex);stat("matchAll");for(let m of matches){if(void 0!==m.groups.name){result.name=m.groups.name;continue}else if(void 0!==m.groups.name2){result.name=m.groups.name2;continue}if(void 0!==m.groups.author){result.author=m.groups.author;continue}if(void 0!==m.groups.cover){result.cover=m.groups.cover.trim();continue}if(void 0!==m.groups.serial){result.serial=("string"==typeof serialChar?-1!==m.groups.serial.indexOf(serialChar):serialChar.test(m.groups.serial))?1:0;continue}void 0!==m.groups.intro&&(result.intro=m.groups.intro);}}if(null!=options.introRegex){stat("intro");let introRegex=".intro>p"===options.introRegex?/<div class="intro">\s*<p>(?<intro>(?:[^<]+|<br\s*\/>)+)</:".intro_info"===options.introRegex?introInfoRegex:options.introRegex;const introMatch=introRegex.exec(html);null!=introMatch&&(result.intro=introMatch.groups.intro),stat("intro");}result.intro=result.intro.replace(/<\/[pP]>|<[bB][rR]\s*\/?>/g,"\n").replace(/<[pP][^>]*>/g,"");}return result.cover&&(result.cover=absoluteUrl(result.cover,url)),stat("collect"),null!=options.postprocess&&options.postprocess(html,result),formatInfo(result)}exports.metaPattern=metaPattern,exports.strongAIntroPattern=strongAIntroPattern,exports.introInfoRegex=introInfoRegex,exports.parseInfo=parseInfo;