const breakPunchCodes=[12290,65281,65311,8221,8230,65289],rightQuote=[8221,8217,12301,12303];function isBreakPunch(a,b,c){return 46===a&&46===b&&46===c||-1!==breakPunchCodes.indexOf(a)}function noopPageCleaner(a){return a}function simpleMerger(a,b){for(let d of b)a.push(d);}function hasMorePageCleaner(a){if(3<a.length)for(let b=a.length-1;b>a.length-3;b--)if(-1!==a[b].indexOf("\u8BF7\u70B9\u51FB\u4E0B\u4E00\u9875")||-1!==a[b].indexOf("\u70B9\u51FB\u4E0B\u4E00\u9875\u7EE7\u7EED\u9605\u8BFB")||-1!==a[b].indexOf("\u672A\u5B8C\uFF0C\u4E0B\u4E00\u9875\u7EE7\u7EED\u9605\u8BFB")||-1!==a[b].indexOf("\u672A\u5B8C\uFF0C\u8BF7\u7FFB")||-1!==a[b].indexOf("\u672C\u7AE0\u9605\u8BFB\u5B8C\u6BD5\uFF0C")){a.splice(b,a.length-b),0<a.length&&/^(\s|&nbsp;)*-->>?(\s|&nbsp;)*$/.test(a.last)&&a.pop();break}return a}function _repeatAndBreakPunchMerger(a,b,c,d){if(0===b.length)return;if(0===a.length)return void b.forEach(b=>a.push(b));d&&b.first===a.last&&b.shift();const e=a[a.length-1].trim(),f=b[0].trim(),g=e.length,h=e.charCodeAt(g-1);-1===rightQuote.indexOf(f.charCodeAt(0))&&c(h,1<g?e.charCodeAt(g-2):null,2<g?e.charCodeAt(g-3):null)?(a[a.length-1]=e,a.push(f)):a[a.length-1]=e+f;for(let e=1;e<b.length;e++)a.push(b[e]);}function repeatMerger(a,b){if(0!==b.length){if(0===a.length)return void b.forEach(b=>a.push(b));a[a.length-1]!==b[0]&&a.push(b[0]);for(let c=1;c<b.length;c++)a.push(b[c]);}}function breakPunchMerger(a,b,c){_repeatAndBreakPunchMerger(a,b,c,!1);}function repeatAndBreakPunchMerger(a,b,c){_repeatAndBreakPunchMerger(a,b,c,!0);}function cleanContent(a){return a.map(a=>a.replace(/[\u200B-\u200F\uFEFF\u0300-\u036f]/g,"")).filter(a=>0<a.length)}function cleanContentAd(a){const b=/(?:请?退出转码页面，)?请下载.+阅读最新(?:章节|内容)。?/,c=/安卓、IOS版本请访问官网.+下载最新版本。如浏览器禁止访问，请换其他浏览器试试；如有异常请邮件反馈。/;for(let d=0;d<a.length;d++){if(/(推荐|讲真|话说|运行多年的|更新迟缓的问题|可能随时关闭|目前用下来).+(追[书更]|软件|[aA]pp).+\w+\.\w+/.test(a[d])){a.splice(d,1);break}if(b.test(a[d])){a[d]=a[d].replace(b,"").trim();break}if(c.test(a[d])){a[d]=a[d].replace(c,"").trim();break}}return a}function cleanContentRemember(a){return 2<a.length&&/^(?:[\s　	]|&#?\w+;)*(?:请收藏本站|【本章阅读完毕|(?:(?:你是)?天才，?)?[一1]秒记住|请记住本书首发|喜欢.+请大家收藏|先定个小目标|手机用户请浏览)[^<>]+(小说网|[地网]址|\w+\.\w+\.\w+)/.test(a.last)&&(/https?:\/\//.test(a[a.length-2])?a.splice(a.length-2,2):a.splice(a.length-1,1)),a}function removeWhitespaceAdTransformer(a){return a.replace(/[\s　]{4,}(一秒记住|(记住|首发)网址)[^<]+/,"")}function trimContentFragment(a,b,c){const d=b.exec(a);if(!d)return a;c||(c="div"),a=a.substring(d.index+d[0].length);const e=new RegExp(`<${c}(?: [^>]*)?>`,"ig"),f=new RegExp(`</${c}>`,"ig");for(let d=f.exec(a);d;){let b=a.substring(0,d.index);const c=Array.from(b.matchAll(new RegExp(e))),g=Array.from(b.matchAll(new RegExp(f)));if(c.length>g.length){let b;for(let e=0;e<c.length-g.length;e++)b=f.exec(a),b&&(d=b);if(b)continue;break}if(0<c.length){const a=[];for(let b of c)a.push({type:0,start:b.index,end:b.index+b[0].length});for(let b of g)a.push({type:1,start:b.index,end:b.index+b[0].length});a.sort((c,a)=>c.start-a.start);const d=[];let e=0;for(let c=0;c<a.length;c++){const f=a[c];if(0===f.type){d.push(b.substring(e,f.start));let g=0;for(let b=c+1;b<a.length;b++){if(0===a[b].type){g++;continue}if(1===a[b].type){if(0===g){e=a[b].end,c=b;break}g--;}}}}a[a.length-1].end<b.length&&d.push(b.substring(a[a.length-1].end)),b=d.join("");}return b}return a}function trimBeforeContent(a,b){const c=b instanceof RegExp?b:new RegExp(`(?:id|class)="${b}(?: [^"]*)?"[^>]*>`),d=c.exec(a);return d&&(a=a.substring(d.index+d[0].length)),a}function removeTrailingObfuscateTransformer(a){const b=a.split("\n");if(5<b.length)return a;if(2===b.length)return b[0];for(let c=1;c<b.length;c++)if(-1!==b[c].indexOf("\u7F51\u9875\u7248\u7AE0\u8282\u5185\u5BB9\u6162")||-1!==b[c].indexOf("\u8BF7\u9000\u51FA\u8F6C\u7801\u9875\u9762")||-1!==b[c].indexOf("\u7F51\u7AD9\u5373\u5C06\u5173\u95ED\uFF0C\u4E0B\u8F7D")){b.splice(c,b.length-c);break}return b.join("\n")}function removeTrailingBrBrNObfuscateTransformer(a){const b=/<br\s*\/?><br\s*\/?>\r*\n/.exec(a);return b?a.substring(0,b.index):a}function removeTrailingBrBrObfuscateTransformer(a){const b=/<br\s*\/?><br\s*\/?>[^<]+(看最新章节|无广告免费阅读|网站已经不更新)/.exec(a);return b?a.substring(0,b.index):a}function removeTrailingNonContentTags(a){const b=/<\/?[ac-oq-z]+(?: [^>]*)?>/i.exec(a);return b?a.substring(0,b.index):a}const paragraphContentRegexFragment="(?<fragment>(?:[^<]|<br\\s*\\/?>|<p[^>]*>|<\\/p>|<[^\\/a-zA-Z])*)",brContentRegexFragment="(?<fragment>(?:[^<]|<br\\s*\\/?>|<[^\\/a-zA-Z])*)";function parseWrapperRegex(a){if(null==a)return null;if(a instanceof RegExp)return {pattern:a};if("object"==typeof a)return a;if("div#content"===a)return {cleaner:a=>trimContentFragment(a.replace(/id=['"]content['"][^>]*>[^<]*(?:<[pP][^>]*>)?(?:[^<]|<\/?a[^>]*>)+(?:最新章节！|天才一秒记住|免费阅读！|本站网址:|最快更新[^<]+[！!])(?:[^<]|<\/?a[^>]*>)*(?:<\/[pP]>)?[^<]*/,"id=\"content\">"),/id=['"]content['"][^>]*>/,"div")};if("div.content"===a)return {cleaner:a=>trimContentFragment(a,/class=["']cont[ea]nt(?: [^"']*)?["'][^>]*>/,"div")};if("div#BookText"===a)return {cleaner:a=>trimContentFragment(a,/id=['"]book_?text['"][^>]*>(?:[^<]*一秒记住[^<]*<a[^>]+>[^<]*<\/a>[^<]*)?/i,"div")};if("div#booktxt"===a)return {cleaner:a=>trimContentFragment(a,/id=['"]booktxt['"][^>]*>/i,"div")};if("div#htmlContent"===a)return {cleaner:a=>trimContentFragment(a,/id="htmll?Content"[^>]*>/,"div").replace(/<p[^>]*>[^<]*((?:<a[^>]+>[^<]+<\/a>|\w+\.\w+)[^<]*(最新章节|[^<]*免费阅读)|最快更新[^<]+)！<\/p>/g,"").replace(/^[^<]+((?:<a[^>]+>[^<]+<\/a>|\w+\.\w+)[^<]*(最新章节|[^<]*免费阅读)|最快更新[^<]+)！/,"")};if("div.article-body"===a)return {cleaner:a=>trimContentFragment(a,/class=['"]article-body[^'"]*['"][^>]*>/,"div")};if("#chaptercontent"===a)return {cleaner:a=>trimContentFragment(a,/id=['"]chaptercontent['"][^>]*>/i,"div")};if("#txt"===a)return {cleaner:a=>trimContentFragment(a,/id=['"]txt['"][^>]*>/i,"div")};if("#TextContent"===a)return {cleaner:a=>trimContentFragment(a,/id=['"]TextContent['"][^>]*>/i,"div")};if("#acontent"===a)return {cleaner:a=>trimContentFragment(a,/id=['"]acontent['"][^>]*>/i,"div")};throw new Error(`unknown ParseContent wrapperRegex ${a}`)}function findNodeNameEnd(a,b){let d=a.charAt(b);if("/"===d&&(b+=1),d=a.charAt(b),!("a"<=d&&"z">=d||"A"<=d&&"Z">=d))return -1;for(let c=b+1;c<a.length;c++)if(d=a.charAt(c),!("a"<=d&&"z">=d||"A"<=d&&"Z">=d||"-"===d||"_"===d))return c;return -1}function collectLines(a,b){a=a.trim();let d,e,f=0;for(d=0;d<a.length;d++)if(e=a.charAt(d),"<"===e){const c=findNodeNameEnd(a,d+1);if(-1===c)continue;if(d>f){const c=a.substring(f,d).trimHTMLSpace();0<c.length&&b.push(c);}let e=a.substring(d+("/"===a.charAt(d+1)?2:1),c).toLowerCase();if("br"===e||"p"===e){const b=a.indexOf(">",c);if(-1===b)return;if(f=b+1,d=b,"p"===e){let c=a.indexOf("</p>",b);if(-1===c&&(c=a.indexOf("</P>",b)),-1!==c&&/<a /i.test(a.substring(b,c)))return}}else return}if(d>f){const c=a.substring(f,d).trimHTMLSpace();0<c.length&&b.push(c);}}const whitespaceRegex=/^([\s　	]|<[bB][rR]\s*\/?>|&nbsp;|<[pP][^>]*>([\s　]|<[bB][rR]\s*\/?>|&nbsp;)*<\/[pP]>)+/;function trimLeadingNonContentTags(a){a=a.replace(whitespaceRegex,"");let b=a.subRegex(/^<([^>\s]+)[^>]*>/);if(!b)return a;if(b=b.toLowerCase(),"p"===b)return a;const c=new RegExp(`<\\/${b}>`,"i").exec(a);return c?trimLeadingNonContentTags(a.substring(c.index+c[0].length)):a}async function extractFragment(a,b){let c;return null==b?c=a:(c=null==b.pattern?a:b.pattern.exec(a).groups.fragment,null!=b.cleaner&&(c=b.cleaner(c),c=c.replace(/<br\s*\/?>(?:[^<]*<a( [^>]*)?>[^<]*<\/a>)+[^<]*/g,"<br/>").replace(/<p[^>]*>(?:[^<]*<a( [^>]*)?>[^<]*<\/a>)+[^<]*<\/p>/g,"").replace(/<br\s*\/?>/ig,"&lt;br/&gt;").replace(/<p[^>]*>[^<]*<[a-oq-z][a-z\d]*[^>]*>(?:[^<]*<(\w+)[^>]*>[^<]*<\/\w+>)?[^<]*<\/[a-oq-z][a-z\d]*>[^<]*<\/p>/ig,"").replace(/<[a-oq-z][a-z\d]*[^>]*>[^<]*<\/[a-oq-z][a-z\d]*[^>]*>/ig,"").replace(/<[a-oq-z][a-z\d]*[^>]*>[^<]*<\/[a-oq-z][a-z\d]*[^>]*>/ig,"").replace(/<[a-oq-z][a-z\d]*[^>]*>[^<]*<\/[a-oq-z][a-z\d]*[^>]*>/ig,"").replace(/&lt;br\/&gt;/g,"<br/>"))),c.replace(/<!-([^-]|-[^>])+->/g,"").trim()}async function parseContent(a,b,c){const d=[];c=c||{};const e={encoding:"utf-8",...c.clientOptions};let f;if(c.webview){const b=require("webview_fetch");f=await b(a,{mobile:1===e["x-mobile"],...c.webviewOptions});}else {const b={url:a,...c.httpOptions};c.lvt&&(!b.headers&&(b.headers={}),b.headers={cookie:lvtCookie(c.lvt)});const{send:d}=require("http");stat("request");let g=await d(b,e);if(stat("request"),c.onBlocked&&isBlocked(g))return c.onBlocked().then(formatBookContent);if(null!=c.retry&&(g=await handleRequestRetry(g,b,e,d,c.retry)),c.fallbackToWebview&&c.fallbackToWebview(g)){const b=require("webview_fetch");f=await b(a,{mobile:1===e["x-mobile"],...c.webviewOptions});}else assertOK(g),f=g.body;}if(null!=c.preprocess&&(f=await c.preprocess(f)),null!=c.parser){const a=await c.parser(f);return formatBookContent(a)}f=cleanHTML(f);let g=parseWrapperRegex(b);stat("fragment");let h=await extractFragment(f,g);if(stat("fragment"),null!=c.transformer){stat("transformer");const a=c.transformer(h);h=a instanceof Promise?await a:a,stat("transformer");}return stat("collect"),collectLines(h,d),stat("collect"),formatBookContent(cleanContent(d))}async function parseContentPaginate(a,b,c){let d=1;const e=[];let f=!0;const g={encoding:"utf-8",...c.clientOptions};let h=parseWrapperRegex(b),i=c.pageCleaner||noopPageCleaner;const j=c.maxPage??10;do{if(d>j)break;const b=a(d);let k;if(c.webview){const a=require("webview_fetch");k=await a(b,{mobile:1===g["x-mobile"],...c.webviewOptions});}else {const a={url:b,...c.httpOptions};c.lvt&&(!a.headers&&(a.headers={}),a.headers={cookie:lvtCookie(c.lvt)});const{send:d}=require("http");stat("request");let e=await d(a,g);if(stat("request"),c.onBlocked&&isBlocked(e))return c.onBlocked().then(formatBookContent);if(null!=c.retry&&(e=await handleRequestRetry(e,a,g,d,c.retry)),c.fallbackToWebview&&c.fallbackToWebview(e)){const a=require("webview_fetch");k=await a(b,{mobile:1===g["x-mobile"],...c.webviewOptions});}else assertOK(e),k=e.body;}null!=c.preprocess&&(k=await c.preprocess(k)),f=c.hasNextFn(k,d);let l=void 0===c.merger?breakPunchMerger:c.merger;let m;if(null!=c.parser){const a=await c.parser(k);m=i(a instanceof Array?a:a.content);}else {k=cleanHTML(k);let a=await extractFragment(k,h);if(null!=c.transformer){const b=c.transformer(a);a=b instanceof Promise?await b:b;}const b=[];collectLines(a,b),m=i(b);}l?l(e,m,isBreakPunch):m.forEach(a=>e.push(a)),0!==c.delay&&(await delay(c.delay||200)),d++;}while(f);return formatBookContent(cleanContent(e))}async function parseBiXiaPaginate(a,b,c){const d={};return c?.lvt&&(d.headers={cookie:lvtCookie(c.lvt)}),parseContentPaginate(b=>1===b?a:a.replace(".html",`${c?.pageChar??"_"}${b}.html`),"div#content",{httpOptions:d,clientOptions:b,hasNextFn:a=>null!=(c?.pageRegex??/\/\d+_\d+\.html/).exec(getLinkElement(a,"id=\"pager_next\"")),pageCleaner:hasMorePageCleaner}).then(cleanContentRemember)}const htmlContent3DotsPaginateOptions={hasNextFn:a=>null!=/id="linkNext"[^>]+href="[^"]*\d+_\d+\.html"/.exec(a),transformer:a=>a.replace(/<p class="text-danger[^>]+>[^<]+<\/p>/,""),pageCleaner:a=>(0<a.length&&(a.last=a.last.replace(/\.\.\.\s*-->>\s*$/,"").trim()),a),merger:(c,d,e)=>{if(0<c.length&&0<d.length){const e=c.last,a=d.first;if(0<e.length||0<a.length)for(let b=4;2<b;b--){let f=e.substring(e.length-b),g=a.substring(0,b);if(f===g){c.last+=a.substring(b),d.shift();for(let a of d)c.push(a);return}}}breakPunchMerger(c,d,e);}},googleAdPattern=/<div [^>]+(google|gad)[^>]*>.+?<\/div>|<p>\s*<a [^>]*>[^<]*<\/a>\s*<\/p>/g;function getXiaYiYeElement(a){let b=0,c=0;for(;-1!==b;){b=a.indexOf("\u4E0B\u4E00\u9875",c);let d=a.indexOf("</a>",b);if(-1===d||20<d-b){c=b+3;continue}return a.substring(a.lastIndexOf("<a",b),b)}return null}function getXiaYiZhangElement(a){let b=0,c=0;for(;-1!==b;){b=a.indexOf("\u4E0B\u4E00\u7AE0",c);let d=a.indexOf("</a>",b);if(-1===d||20<d-b){c=b+3;continue}return a.substring(a.lastIndexOf("<a",b),b)}return null}function getLinkElement(b,c){let d=b.indexOf(c);if(-1===d)return null;let e=b.substring(0,b.indexOf(">",d));return e.substring(e.lastIndexOf("<"))}function getNextUrlElement(a){return getLinkElement(a,"id=\"next_url\"")}function getLinkNextElement(a){return getLinkElement(a,"id=\"linkNext\"")}function buildImg(a,b){return `[img{"alt":"${b??""}"}!${a}]`}function extractDataId(a){return a.subRegexMapAll(/data-id="(?<o>\d+)"[^>]*>(?<c>(?:[^<]|<\/?p[^>]*>)+)/g).map(a=>(a.o=parseInt(a.o),a)).sort((c,a)=>c.o-a.o).filter(a=>999>a.o).map(a=>a.c).join("\n")}exports.parseContent=parseContent,exports.parseContentPaginate=parseContentPaginate,exports.parseBiXiaPaginate=parseBiXiaPaginate,exports.simpleMerger=simpleMerger,exports.repeatMerger=repeatMerger,exports.breakPunchMerger=breakPunchMerger,exports.repeatAndBreakPunchMerger=repeatAndBreakPunchMerger,exports.isBreakPunch=isBreakPunch,exports.hasMorePageCleaner=hasMorePageCleaner,exports.cleanContent=cleanContent,exports.cleanContentAd=cleanContentAd,exports.cleanContentRemember=cleanContentRemember,exports.trimBeforeContent=trimBeforeContent,exports.trimContentFragment=trimContentFragment,exports.trimLeadingNonContentTags=trimLeadingNonContentTags,exports.removeTrailingNonContentTags=removeTrailingNonContentTags,exports.removeTrailingObfuscateTransformer=removeTrailingObfuscateTransformer,exports.removeTrailingBrBrObfuscateTransformer=removeTrailingBrBrObfuscateTransformer,exports.removeTrailingBrBrNObfuscateTransformer=removeTrailingBrBrNObfuscateTransformer,exports.removeWhitespaceAdTransformer=removeWhitespaceAdTransformer,exports.collectLines=collectLines,exports.extractFragment=extractFragment,exports.getXiaYiYeElement=getXiaYiYeElement,exports.getXiaYiZhangElement=getXiaYiZhangElement,exports.getNextUrlElement=getNextUrlElement,exports.getLinkNextElement=getLinkNextElement,exports.getLinkElement=getLinkElement,exports.buildImg=buildImg,exports.extractDataId=extractDataId,exports.paragraphContentRegexFragment=paragraphContentRegexFragment,exports.brContentRegexFragment=brContentRegexFragment,exports.googleAdPattern=googleAdPattern,exports.htmlContent3DotsPaginateOptions=htmlContent3DotsPaginateOptions;