const breakPunchCodes=[12290,65281,65311,8221,8230];function isBreakPunch(a,b,c){return 46===a&&46===b&&46===c||-1!==breakPunchCodes.indexOf(a)}function noopPageCleaner(a){return a}function hasMorePageCleaner(a){return 2<a.length&&-1!==a.last.indexOf("\u8BF7\u70B9\u51FB\u4E0B\u4E00\u9875")&&a.pop(),a}function repeatMerger(a,b){if(0!==b.length){if(0===a.length)return void b.forEach(b=>a.push(b));a[a.length-1]!==b[0]&&a.push(b[0]);for(let c=1;c<b.length;c++)a.push(b[c]);}}function cleanContent(a){return a.map(a=>a.replace(/[\u200B-\u200F\uFEFF\u0300-\u036f]/g,"")).filter(a=>0<a.length)}function cleanContentAd(a){const b=/(?:请?退出转码页面，)?请下载.+ 阅读最新(?:章节|内容)。?/;for(let c=0;c<a.length;c++){if(/(推荐|讲真).+(追[书更]|软件).+\w+\.\w+\.\w+/.test(a[c])){a.splice(c,1);break}if(b.test(a[c])){a[c]=a[c].replace(b,"").trim();break}}return a}function cleanContentRemember(a){return 2<a.length&&/^(?:[\s　]|&#?\w+;)*(?:请收藏本站|(?:(?:你是)?天才，?)?[一1]秒记住|请记住本书首发|喜欢.+请大家收藏).+([地网]址|\w+\.\w+\.\w+)/.test(a.last)&&(/https?:\/\//.test(a[a.length-2])?a.splice(a.length-2,2):a.splice(a.length-1,1)),a}function trimBeforeContent(a,b){const c=b instanceof RegExp?b:new RegExp(`(?:id|class)="${b}(?: [^"]*)?"[^>]*>`),d=c.exec(a);return d&&(a=a.substring(d.index+d[0].length)),a}function removeTrailingObfuscateTransformer(a){const b=a.split("\n");return 2===b.length?b[0]:a}function removeTrailingNonContentTags(a){const b=/(?:<br\s*\/?>|<p(?: [^>]*)?>[^<]*<\/p>|[^<])+/.exec(a);return b?b[0]:a}const paragraphContentRegexFragment="(?<fragment>(?:[^<]|<br\\s*\\/?>|<p[^>]*>|<\\/p>|<[^\\/a-zA-Z])*)",brContentRegexFragment="(?<fragment>(?:[^<]|<br\\s*\\/?>|<[^\\/a-zA-Z])*)";function parseWrapperRegex(a){if(null==a)return null;if(a instanceof RegExp)return {pattern:a};if("object"==typeof a)return a;if("div#content"===a)return {cleaner:a=>trimBeforeContent(a,/id="content(?: [^"]*)?"[^>]*>/)};if("div.content"===a)return {cleaner:a=>trimBeforeContent(a,/class="content(?: [^"]*)?"[^>]*>/)};if("div#BookText"===a)return {cleaner:a=>trimBeforeContent(a,"BookText")};if("div#booktxt"===a)return {cleaner:a=>trimBeforeContent(a,"booktxt")};if("div#htmlContent"===a)return {cleaner:a=>trimBeforeContent(a,"htmlContent")};if("div.article-body>p"===a)return {cleaner:a=>trimBeforeContent(a,"article-body")};if("div#chapter_content>p"===a)return {cleaner:a=>trimBeforeContent(a,"chapter_content")};if("#chaptercontent"===a)return {cleaner:a=>trimBeforeContent(a,"chaptercontent")};if("div#txt>p"===a)return {cleaner:a=>trimBeforeContent(a,"txt")};if("#acontent"===a)return {cleaner:a=>trimBeforeContent(a,"acontent")};throw new Error(`unknown ParseContent wrapperRegex ${a}`)}function findNodeNameEnd(a,b){let d=a.charAt(b);if("/"===d&&(b+=1),d=a.charAt(b),!("a"<=d&&"z">=d||"A"<=d&&"Z">=d))return -1;for(let c=b+1;c<a.length;c++)if(d=a.charAt(c),!("a"<=d&&"z">=d||"A"<=d&&"Z">=d||"-"===d||"_"===d))return c;return -1}function collectLines(a,b){a=a.trim();let d,e,f=0;for(d=0;d<a.length;d++)if(e=a.charAt(d),"<"===e){const c=findNodeNameEnd(a,d+1);if(-1===c)continue;if(d>f){const c=a.substring(f,d).trim();0<c.length&&b.push(c);}let e=a.substring(d+("/"===a.charAt(d+1)?2:1),c).toLowerCase();if("br"===e||"p"===e){const b=a.indexOf(">",c);if(-1===b)return;if(f=b+1,d=b,"p"===e){let c=a.indexOf("</p>",b);if(-1===c&&(c=a.indexOf("</P>",b)),-1!==c&&/<a /i.test(a.substring(b,c)))return}}else return}if(d>f){const c=a.substring(f,d).trim();0<c.length&&b.push(c);}}function simpleMerger(a,b){for(let d of b)a.push(d);}async function extractFragment(a,b){let c;if(null==b)c=a;else if(c=null==b.pattern?a:b.pattern.exec(a).groups.fragment,null!=b.cleaner){c=b.cleaner(c);const{removeLeadingNonContentTags:a}=await require("transcode/utils");c=a(c),c=removeTrailingNonContentTags(c);}return c}async function parseContent(a,b,c){const d=[];c=c||{};const e={encoding:"utf-8",...c.clientOptions};let f;if(c.webview){const b=require("webview_fetch");f=await b(a,{mobile:1===e["x-mobile"]});}else {const b={url:a,...c.httpOptions},{send:d}=require("http");stat("request");let g=await d(b,e);if(stat("request"),c.onBlocked&&isBlocked(g))return c.onBlocked();if(null!=c.retry&&(g=await handleRequestRetry(g,b,e,d)),c.fallbackToWebview&&c.fallbackToWebview(g)){const b=require("webview_fetch");f=await b(a,{mobile:1===e["x-mobile"]});}else assertOK(g),f=g.body;}if(null!=c.preprocess&&(f=c.preprocess(f)),null!=c.parser)return c.parser(f);f=cleanHTML(f);let g=parseWrapperRegex(b);stat("fragment");let h=await extractFragment(f,g);if(stat("fragment"),null!=c.transformer){stat("transformer");const a=c.transformer(h);h=a instanceof Promise?await a:a,stat("transformer");}return stat("collect"),collectLines(h,d),stat("collect"),cleanContent(d)}async function parseContentPaginate(a,b,c){let d=1;const e=[];let f=!0;const g={encoding:"utf-8",...c.clientOptions};let h=parseWrapperRegex(b),i=c.pageCleaner||noopPageCleaner;do{if(10<d)break;const b=a(d);let j;if(c.webview){const a=require("webview_fetch");j=await a(b,{mobile:1===g["x-mobile"]});}else {const a={url:b,...c.httpOptions},{send:d}=require("http");stat("request");let e=await d(a,g);if(stat("request"),c.onBlocked&&isBlocked(e))return c.onBlocked();if(null!=c.retry&&(e=await handleRequestRetry(e,a,g,d)),c.fallbackToWebview&&c.fallbackToWebview(e)){const a=require("webview_fetch");j=await a(b,{mobile:1===g["x-mobile"]});}else assertOK(e),j=e.body;}null!=c.preprocess&&(j=c.preprocess(j)),f=c.hasNextFn(j);let k;if(k=void 0===c.merger?(a,b,c)=>{if(0!==b.length){if(0===a.length)return void b.forEach(b=>a.push(b));const d=a[a.length-1].trim(),e=b[0].trim(),f=d.length,g=d.charCodeAt(f-1);c(g,1<f?d.charCodeAt(f-2):null,2<f?d.charCodeAt(f-3):null)?(a[a.length-1]=d,a.push(e)):a[a.length-1]=d+e;for(let c=1;c<b.length;c++)a.push(b[c]);}}:c.merger,null!=c.parser){const a=await c.parser(j);null==k?i(a instanceof Array?a:a.content).forEach(a=>e.push(a)):k(e,i(a instanceof Array?a:a.content),isBreakPunch);}else {j=cleanHTML(j);let a=await extractFragment(j,h);if(null!=c.transformer){const b=c.transformer(a);a=b instanceof Promise?await b:b;}if(k){const b=[];collectLines(a,b),k(e,i(b),isBreakPunch);}else collectLines(a,e);0!==c.delay&&(await delay(c.delay||200));}d++;}while(f);return cleanContent(e)}exports.parseContent=parseContent,exports.parseContentPaginate=parseContentPaginate,exports.simpleMerger=simpleMerger,exports.repeatMerger=repeatMerger,exports.hasMorePageCleaner=hasMorePageCleaner,exports.cleanContent=cleanContent,exports.cleanContentAd=cleanContentAd,exports.cleanContentRemember=cleanContentRemember,exports.trimBeforeContent=trimBeforeContent,exports.removeTrailingNonContentTags=removeTrailingNonContentTags,exports.removeTrailingObfuscateTransformer=removeTrailingObfuscateTransformer,exports.paragraphContentRegexFragment=paragraphContentRegexFragment,exports.brContentRegexFragment=brContentRegexFragment;