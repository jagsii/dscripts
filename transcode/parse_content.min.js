const breakPunchCodes=[12290,65281,65311,8221,8230,65289],rightQuote=[8221,8217,12301,12303];function isBreakPunch(charCode,charCodeLast2,charCodeLast3){return 46===charCode&&46===charCodeLast2&&46===charCodeLast3||-1!==breakPunchCodes.indexOf(charCode)}function noopPageCleaner(pageContent){return pageContent}function simpleMerger(content,pageContent){for(let c of pageContent)content.push(c);}function hasMorePageCleaner(pageContent){if(3<pageContent.length)for(let i=pageContent.length-1;i>pageContent.length-3;i--)if(-1!==pageContent[i].indexOf("\u8BF7\u70B9\u51FB\u4E0B\u4E00\u9875")||-1!==pageContent[i].indexOf("\u70B9\u51FB\u4E0B\u4E00\u9875\u7EE7\u7EED\u9605\u8BFB")||-1!==pageContent[i].indexOf("\u672A\u5B8C\uFF0C\u4E0B\u4E00\u9875\u7EE7\u7EED\u9605\u8BFB")||-1!==pageContent[i].indexOf("\u672A\u5B8C\uFF0C\u8BF7\u7FFB")||-1!==pageContent[i].indexOf("\u672C\u7AE0\u9605\u8BFB\u5B8C\u6BD5\uFF0C")){pageContent.splice(i,pageContent.length-i),0<pageContent.length&&/^(\s|&nbsp;)*-->>?(\s|&nbsp;)*$/.test(pageContent.last)&&pageContent.pop();break}return pageContent}function _repeatAndBreakPunchMerger(content,pageContent,isPunch,handleRepeat){if(0===pageContent.length)return;if(0===content.length)return void pageContent.forEach(_=>content.push(_));handleRepeat&&pageContent.first===content.last&&pageContent.shift();const prevLast=content[content.length-1].trim(),nextFirst=pageContent[0].trim(),prevLastLength=prevLast.length,lastChar=prevLast.charCodeAt(prevLastLength-1);-1===rightQuote.indexOf(nextFirst.charCodeAt(0))&&isPunch(lastChar,1<prevLastLength?prevLast.charCodeAt(prevLastLength-2):null,2<prevLastLength?prevLast.charCodeAt(prevLastLength-3):null)?(content[content.length-1]=prevLast,content.push(nextFirst)):content[content.length-1]=prevLast+nextFirst;for(let i=1;i<pageContent.length;i++)content.push(pageContent[i]);}function repeatMerger(content,pageContent){if(0!==pageContent.length){if(0===content.length)return void pageContent.forEach(_=>content.push(_));content[content.length-1]!==pageContent[0]&&content.push(pageContent[0]);for(let i=1;i<pageContent.length;i++)content.push(pageContent[i]);}}function breakPunchMerger(content,pageContent,isPunch){_repeatAndBreakPunchMerger(content,pageContent,isPunch,!1);}function repeatAndBreakPunchMerger(content,pageContent,isPunch){_repeatAndBreakPunchMerger(content,pageContent,isPunch,!0);}function cleanContent(content){return content.map(_=>_.replace(/[\u200B-\u200F\uFEFF\u0300-\u036f]/g,"")).filter(_=>0<_.length)}function cleanContentAd(content){const regex2=/(?:请?退出转码页面，)?请下载.+阅读最新(?:章节|内容)。?/,regex3=/安卓、IOS版本请访问官网.+下载最新版本。如浏览器禁止访问，请换其他浏览器试试；如有异常请邮件反馈。/;for(let i=0;i<content.length;i++){if(/(推荐|讲真|话说|运行多年的|更新迟缓的问题|可能随时关闭|目前用下来).+(追[书更]|软件|[aA]pp).+\w+\.\w+/.test(content[i])){content.splice(i,1);break}if(regex2.test(content[i])){content[i]=content[i].replace(regex2,"").trim();break}if(regex3.test(content[i])){content[i]=content[i].replace(regex3,"").trim();break}}return content}function cleanContentRemember(content){return 2<content.length&&/^(?:[\s　	]|&#?\w+;)*(?:请收藏本站|【本章阅读完毕|(?:(?:你是)?天才，?)?[一1]秒记住|请记住本书首发|喜欢.+请大家收藏|先定个小目标|手机用户请浏览)[^<>]+(小说网|[地网]址|\w+\.\w+\.\w+)/.test(content.last)&&(/https?:\/\//.test(content[content.length-2])?content.splice(content.length-2,2):content.splice(content.length-1,1)),content}function removeWhitespaceAdTransformer(fragment){return fragment.replace(/[\s　]{4,}(一秒记住|(记住|首发)网址)[^<]+/,"")}function trimContentFragment(html,regex,tagName){const matcher=regex.exec(html);if(!matcher)return html;tagName||(tagName="div"),html=html.substring(matcher.index+matcher[0].length);const startTag=new RegExp(`<${tagName}(?: [^>]*)?>`,"ig"),endTag=new RegExp(`</${tagName}>`,"ig");for(let me=endTag.exec(html);me;){let h=html.substring(0,me.index);const starts=Array.from(h.matchAll(new RegExp(startTag))),ends=Array.from(h.matchAll(new RegExp(endTag)));if(starts.length>ends.length){let mme;for(let i=0;i<starts.length-ends.length;i++)mme=endTag.exec(html),mme&&(me=mme);if(mme)continue;break}if(0<starts.length){const mm=[];for(let m of starts)mm.push({type:0,start:m.index,end:m.index+m[0].length});for(let m of ends)mm.push({type:1,start:m.index,end:m.index+m[0].length});mm.sort((a,b)=>a.start-b.start);const r=[];let s=0;for(let i=0;i<mm.length;i++){const m=mm[i];if(0===m.type){r.push(h.substring(s,m.start));let level=0;for(let j=i+1;j<mm.length;j++){if(0===mm[j].type){level++;continue}if(1===mm[j].type){if(0===level){s=mm[j].end,i=j;break}level--;}}}}mm[mm.length-1].end<h.length&&r.push(h.substring(mm[mm.length-1].end)),h=r.join("");}return h}return html}function trimBeforeContent(html,identity){const regex=identity instanceof RegExp?identity:new RegExp(`(?:id|class)="${identity}(?: [^"]*)?"[^>]*>`),matcher=regex.exec(html);return matcher&&(html=html.substring(matcher.index+matcher[0].length)),html}function removeTrailingObfuscateTransformer(html){const tokens=html.split("\n");if(5<tokens.length)return html;if(2===tokens.length)return tokens[0];for(let i=1;i<tokens.length;i++)if(-1!==tokens[i].indexOf("\u7F51\u9875\u7248\u7AE0\u8282\u5185\u5BB9\u6162")||-1!==tokens[i].indexOf("\u8BF7\u9000\u51FA\u8F6C\u7801\u9875\u9762")||-1!==tokens[i].indexOf("\u7F51\u7AD9\u5373\u5C06\u5173\u95ED\uFF0C\u4E0B\u8F7D")){tokens.splice(i,tokens.length-i);break}return tokens.join("\n")}function removeTrailingBrBrNObfuscateTransformer(html){const m=/<br\s*\/?><br\s*\/?>\r*\n/.exec(html);return m?html.substring(0,m.index):html}function removeTrailingBrBrObfuscateTransformer(html){const m=/<br\s*\/?><br\s*\/?>[^<]+(看最新章节|无广告免费阅读|网站已经不更新)/.exec(html);return m?html.substring(0,m.index):html}function removeTrailingNoBrObfuscateTransformer(html){html=html.trim();const pos=html.indexOf("\n");if(-1===pos)return html;const a=html.substring(0,pos),b=html.substring(pos+1),regex=/(<[bB][rR]\s*\/?>)+/g;return regex.test(a)&&!regex.test(b)&&(-1!==b.indexOf("\u7F51\u7AD9\u5373\u5C06\u5173\u95ED\uFF0C\u4E0B\u8F7D")||-1!==b.indexOf("\u8BF7\u9000\u51FA\u8F6C\u7801\u9875\u9762")||-1!==b.indexOf("\u7F51\u9875\u7248\u7AE0\u8282\u5185\u5BB9\u6162"))?a:html}function removeTrailingNonContentTags(html){const matcher=/<\/?[ac-oq-z]+(?: [^>]*)?>/i.exec(html);return matcher?html.substring(0,matcher.index):html}const paragraphContentRegexFragment="(?<fragment>(?:[^<]|<br\\s*\\/?>|<p[^>]*>|<\\/p>|<[^\\/a-zA-Z])*)",brContentRegexFragment="(?<fragment>(?:[^<]|<br\\s*\\/?>|<[^\\/a-zA-Z])*)";function parseWrapperRegex(wrapperRegex){if(null==wrapperRegex)return null;if(wrapperRegex instanceof RegExp)return {pattern:wrapperRegex};if("object"==typeof wrapperRegex)return wrapperRegex;if("div#content"===wrapperRegex)return {cleaner:html=>trimContentFragment(html.replace(/id=['"]content['"][^>]*>[^<]*(?:<[pP][^>]*>)?(?:[^<]|<\/?a[^>]*>)+(?:最新章节！|(天才)?一秒记住|免费阅读！|本站网址:|最快更新[^<]+[！!])(?:[^<]|<\/?a[^>]*>)*(?:<\/[pP]>)?[^<]*/,"id=\"content\">"),/id=['"]content['"][^>]*>/,"div")};if("div.content"===wrapperRegex)return {cleaner:html=>trimContentFragment(html,/class=["']cont[ea]nt(?: [^"']*)?["'][^>]*>/,"div")};if("div#BookText"===wrapperRegex)return {cleaner:html=>trimContentFragment(html,/id=['"]book_?text['"][^>]*>(?:[^<]*一秒记住[^<]*<a[^>]+>[^<]*<\/a>[^<]*)?/i,"div")};if("div#booktxt"===wrapperRegex)return {cleaner:html=>trimContentFragment(html,/id=['"]booktxt['"][^>]*>/i,"div")};if("div#htmlContent"===wrapperRegex)return {cleaner:html=>trimContentFragment(html,/id="htmll?Content"[^>]*>/,"div").replace(/<p[^>]*>[^<]*((?:<a[^>]+>[^<]+<\/a>|\w+\.\w+)[^<]*(最新章节|[^<]*免费阅读)|最快更新[^<]+)！<\/p>/g,"").replace(/^[^<]+((?:<a[^>]+>[^<]+<\/a>|\w+\.\w+)[^<]*(最新章节|[^<]*免费阅读)|最快更新[^<]+)！/,"")};if("div.article-body"===wrapperRegex)return {cleaner:html=>trimContentFragment(html,/class=['"]article-body[^'"]*['"][^>]*>/,"div")};if("#chaptercontent"===wrapperRegex)return {cleaner:html=>trimContentFragment(html,/id=['"]chaptercontent['"][^>]*>/i,"div")};if("div#articlecontent"===wrapperRegex)return {cleaner:html=>trimContentFragment(html,/id="articlecontent"[^>]*>/i,"div")};if("#txt"===wrapperRegex)return {cleaner:html=>trimContentFragment(html,/id=['"]txt['"][^>]*>/i,"div")};if("#TextContent"===wrapperRegex)return {cleaner:html=>trimContentFragment(html,/id=['"]TextContent['"][^>]*>/i,"div")};if(".pt-read-text"===wrapperRegex)return {cleaner:html=>trimContentFragment(html,/ pt-read-text"[^>]*>/)};if("#acontent"===wrapperRegex)return {cleaner:html=>trimContentFragment(html,/id=['"]acontent['"][^>]*>/i,"div")};throw new Error(`unknown ParseContent wrapperRegex ${wrapperRegex}`)}function findNodeNameEnd(html,start){let c=html.charAt(start);if("/"===c&&(start+=1),c=html.charAt(start),!("a"<=c&&"z">=c||"A"<=c&&"Z">=c))return -1;for(let i=start+1;i<html.length;i++)if(c=html.charAt(i),!("a"<=c&&"z">=c||"A"<=c&&"Z">=c||"-"===c||"_"===c))return i;return -1}function collectLines(html,content){html=html.trim();let i,c,start=0;for(i=0;i<html.length;i++)if(c=html.charAt(i),"<"===c){const nodeNameEnd=findNodeNameEnd(html,i+1);if(-1===nodeNameEnd)continue;if(i>start){const line=html.substring(start,i).trimHTMLSpace();0<line.length&&content.push(line);}let nodeName=html.substring(i+("/"===html.charAt(i+1)?2:1),nodeNameEnd).toLowerCase();if("br"===nodeName||"p"===nodeName){const nodeEnd=html.indexOf(">",nodeNameEnd);if(-1===nodeEnd)return;if(start=nodeEnd+1,i=nodeEnd,"p"===nodeName){let pEnd=html.indexOf("</p>",nodeEnd);if(-1===pEnd&&(pEnd=html.indexOf("</P>",nodeEnd)),-1!==pEnd&&/<a /i.test(html.substring(nodeEnd,pEnd)))return}}else return}if(i>start){const line=html.substring(start,i).trimHTMLSpace();0<line.length&&content.push(line);}}const whitespaceRegex=/^([\s　	]|<[bB][rR]\s*\/?>|&nbsp;|<[pP][^>]*>([\s　]|<[bB][rR]\s*\/?>|&nbsp;)*<\/[pP]>)+/;function trimLeadingNonContentTags(html){html=html.replace(whitespaceRegex,"");let tag=html.subRegex(/^<([^>\s]+)[^>]*>/);if(!tag)return html;if(tag=tag.toLowerCase(),"p"===tag)return html;const m=new RegExp(`<\\/${tag}>`,"i").exec(html);return m?trimLeadingNonContentTags(html.substring(m.index+m[0].length)):html}async function extractFragment(html,htmlParser){let fragment;return null==htmlParser?fragment=html:(fragment=null==htmlParser.pattern?html:htmlParser.pattern.exec(html).groups.fragment,null!=htmlParser.cleaner&&(fragment=htmlParser.cleaner(fragment),fragment=fragment.replace(/<br\s*\/?>(?:[^<]*<a( [^>]*)?>[^<]*<\/a>)+[^<]*/g,"<br/>").replace(/<p[^>]*>(?:[^<]*<a( [^>]*)?>[^<]*<\/a>)+[^<]*<\/p>/g,"").replace(/<br\s*\/?>/ig,"&lt;br/&gt;").replace(/<p[^>]*>[^<]*<[a-oq-z][a-z\d]*[^>]*>(?:[^<]*<(\w+)[^>]*>[^<]*<\/\w+>)?[^<]*<\/[a-oq-z][a-z\d]*>[^<]*<\/p>/ig,"").replace(/<[a-oq-z][a-z\d]*[^>]*>[^<]*<\/[a-oq-z][a-z\d]*[^>]*>/ig,"").replace(/<[a-oq-z][a-z\d]*[^>]*>[^<]*<\/[a-oq-z][a-z\d]*[^>]*>/ig,"").replace(/<[a-oq-z][a-z\d]*[^>]*>[^<]*<\/[a-oq-z][a-z\d]*[^>]*>/ig,"").replace(/&lt;br\/&gt;/g,"<br/>"))),fragment.replace(/<!-([^-]|-[^>])+->/g,"").trim()}async function parseContent(url,wrapperRegex,options){const content=[];options=options||{};const clientOptions={encoding:"utf-8",...options.clientOptions};let html;if(options.webview){const webviewFetch=require("webview_fetch");html=await webviewFetch(url,{mobile:1===clientOptions["x-mobile"],...options.webviewOptions});}else {const httpOptions={url,...options.httpOptions};options.lvt&&(!httpOptions.headers&&(httpOptions.headers={}),httpOptions.headers={cookie:lvtCookie(options.lvt)});const{send}=require("http");stat("request");let response=await send(httpOptions,clientOptions);if(stat("request"),options.onBlocked&&isBlocked(response))return options.onBlocked().then(formatBookContent);if(null!=options.retry&&(response=await handleRequestRetry(response,httpOptions,clientOptions,send,options.retry)),options.fallbackToWebview&&options.fallbackToWebview(response)){const webviewFetch=require("webview_fetch");html=await webviewFetch(url,{mobile:1===clientOptions["x-mobile"],...options.webviewOptions});}else assertOK(response),html=response.body;}if(null!=options.preprocess&&(html=await options.preprocess(html)),null!=options.parser){const _=await options.parser(html);return formatBookContent(_)}html=cleanHTML(html);let htmlParser=parseWrapperRegex(wrapperRegex);stat("fragment");let fragment=await extractFragment(html,htmlParser);if(stat("fragment"),null!=options.transformer){stat("transformer");const _=options.transformer(fragment);fragment=_ instanceof Promise?await _:_,stat("transformer");}return stat("collect"),collectLines(fragment,content),stat("collect"),formatBookContent(cleanContent(content))}async function parseContentPaginate(urlGenerator,wrapperRegex,options){let page=1;const content=[];let hasNext=!0;const clientOptions={encoding:"utf-8",...options.clientOptions};let htmlParser=parseWrapperRegex(wrapperRegex),pageCleaner=options.pageCleaner||noopPageCleaner;const maxPage=options.maxPage??10;do{if(page>maxPage)break;const url=urlGenerator(page);let html;if(options.webview){const webviewFetch=require("webview_fetch");html=await webviewFetch(url,{mobile:1===clientOptions["x-mobile"],...options.webviewOptions});}else {const httpOptions={url,...options.httpOptions};options.lvt&&(!httpOptions.headers&&(httpOptions.headers={}),httpOptions.headers={cookie:lvtCookie(options.lvt)});const{send}=require("http");stat("request");let response=await send(httpOptions,clientOptions);if(stat("request"),options.onBlocked&&isBlocked(response))return options.onBlocked().then(formatBookContent);if(null!=options.retry&&(response=await handleRequestRetry(response,httpOptions,clientOptions,send,options.retry)),options.fallbackToWebview&&options.fallbackToWebview(response)){const webviewFetch=require("webview_fetch");html=await webviewFetch(url,{mobile:1===clientOptions["x-mobile"],...options.webviewOptions});}else assertOK(response),html=response.body;}null!=options.preprocess&&(html=await options.preprocess(html)),hasNext=options.hasNextFn(html,page);let merger=void 0===options.merger?breakPunchMerger:options.merger;let cleaned;if(null!=options.parser){const _=await options.parser(html);cleaned=pageCleaner(_ instanceof Array?_:_.content);}else {html=cleanHTML(html);let fragment=await extractFragment(html,htmlParser);if(null!=options.transformer){const _=options.transformer(fragment);fragment=_ instanceof Promise?await _:_;}const pageContent=[];collectLines(fragment,pageContent),cleaned=pageCleaner(pageContent);}merger?merger(content,cleaned,isBreakPunch):cleaned.forEach(__=>content.push(__)),0!==options.delay&&(await delay(options.delay||200)),page++;}while(hasNext);return formatBookContent(cleanContent(content))}async function parseBiXiaPaginate(url,clientOptions,options){const httpOptions={};return options?.lvt&&(httpOptions.headers={cookie:lvtCookie(options.lvt)}),parseContentPaginate(page=>1===page?url:url.replace(".html",`${options?.pageChar??"_"}${page}.html`),"div#content",{httpOptions,clientOptions,hasNextFn:html=>null!=(options?.pageRegex??/\/\d+_\d+\.html/).exec(getLinkElement(html,"id=\"pager_next\"")),pageCleaner:hasMorePageCleaner}).then(cleanContentRemember)}const htmlContent3DotsPaginateOptions={hasNextFn:html=>null!=/id="linkNext"[^>]+href="[^"]*\d+_\d+\.html"/.exec(html),transformer:fragment=>fragment.replace(/<p class="text-danger[^>]+>[^<]+<\/p>/,""),pageCleaner:pageContent=>(0<pageContent.length&&(pageContent.last=pageContent.last.replace(/\.\.\.\s*-->>\s*$/,"").trim(),pageContent.first=pageContent.first.replace(/^\s*(((n?b)?s)?p)?;/,"")),pageContent),merger:(content,pageContent,isPunch)=>{if(0<content.length&&0<pageContent.length){const a=content.last,b=pageContent.first;if(0<a.length||0<b.length)for(let i=4;2<i;i--){let aa=a.substring(a.length-i),bb=b.substring(0,i);if(aa===bb){content.last+=b.substring(i),pageContent.shift();for(let _ of pageContent)content.push(_);return}}}breakPunchMerger(content,pageContent,isPunch);}},googleAdPattern=/<div [^>]+(google|gad)[^>]*>.+?<\/div>|<p>\s*<a [^>]*>[^<]*<\/a>\s*<\/p>/g;function getXiaYiYeElement(html){let p=0,start=0;for(;-1!==p;){p=html.indexOf("\u4E0B\u4E00\u9875",start);let end=html.indexOf("</a>",p);if(-1===end||20<end-p){start=p+3;continue}return html.substring(html.lastIndexOf("<a",p),p)}return null}function getXiaYiZhangElement(html){let p=0,start=0;for(;-1!==p;){p=html.indexOf("\u4E0B\u4E00\u7AE0",start);let end=html.indexOf("</a>",p);if(-1===end||20<end-p){start=p+3;continue}return html.substring(html.lastIndexOf("<a",p),p)}return null}function getLinkElement(html,search){let p=html.indexOf(search);if(-1===p)return null;let a=html.substring(0,html.indexOf(">",p));return a.substring(a.lastIndexOf("<"))}function getNextUrlElement(html){return getLinkElement(html,"id=\"next_url\"")}function getLinkNextElement(html){return getLinkElement(html,"id=\"linkNext\"")}function buildImg(src,alt){return `[img{"alt":"${alt??""}"}!${src}]`}function extractDataId(content){return content.subRegexMapAll(/data-id="(?<o>\d+)"[^>]*>(?<c>(?:[^<]|<\/?p[^>]*>)+)/g).map(_=>(_.o=parseInt(_.o),_)).sort((a,b)=>a.o-b.o).filter(_=>999>_.o).map(_=>_.c).join("\n")}exports.parseContent=parseContent,exports.parseContentPaginate=parseContentPaginate,exports.parseBiXiaPaginate=parseBiXiaPaginate,exports.simpleMerger=simpleMerger,exports.repeatMerger=repeatMerger,exports.breakPunchMerger=breakPunchMerger,exports.repeatAndBreakPunchMerger=repeatAndBreakPunchMerger,exports.isBreakPunch=isBreakPunch,exports.hasMorePageCleaner=hasMorePageCleaner,exports.cleanContent=cleanContent,exports.cleanContentAd=cleanContentAd,exports.cleanContentRemember=cleanContentRemember,exports.trimBeforeContent=trimBeforeContent,exports.trimContentFragment=trimContentFragment,exports.trimLeadingNonContentTags=trimLeadingNonContentTags,exports.removeTrailingNonContentTags=removeTrailingNonContentTags,exports.removeTrailingObfuscateTransformer=removeTrailingObfuscateTransformer,exports.removeTrailingBrBrObfuscateTransformer=removeTrailingBrBrObfuscateTransformer,exports.removeTrailingBrBrNObfuscateTransformer=removeTrailingBrBrNObfuscateTransformer,exports.removeTrailingNoBrObfuscateTransformer=removeTrailingNoBrObfuscateTransformer,exports.removeWhitespaceAdTransformer=removeWhitespaceAdTransformer,exports.collectLines=collectLines,exports.extractFragment=extractFragment,exports.getXiaYiYeElement=getXiaYiYeElement,exports.getXiaYiZhangElement=getXiaYiZhangElement,exports.getNextUrlElement=getNextUrlElement,exports.getLinkNextElement=getLinkNextElement,exports.getLinkElement=getLinkElement,exports.buildImg=buildImg,exports.extractDataId=extractDataId,exports.paragraphContentRegexFragment=paragraphContentRegexFragment,exports.brContentRegexFragment=brContentRegexFragment,exports.googleAdPattern=googleAdPattern,exports.htmlContent3DotsPaginateOptions=htmlContent3DotsPaginateOptions;