const breakPunchCodes=[12290,65281,65311,8221,8230,65289],rightQuote=8221;function isBreakPunch(a,b,c){return 46===a&&46===b&&46===c||-1!==breakPunchCodes.indexOf(a)}function noopPageCleaner(a){return a}function simpleMerger(a,b){for(let d of b)a.push(d);}function hasMorePageCleaner(a){if(3<a.length)for(let b=a.length-1;b>a.length-3;b--)if(-1!==a[b].indexOf("\u8BF7\u70B9\u51FB\u4E0B\u4E00\u9875")||-1!==a[b].indexOf("\u70B9\u51FB\u4E0B\u4E00\u9875\u7EE7\u7EED\u9605\u8BFB")){a.splice(b,a.length-b),0<a.length&&/^(\s|&nbsp;)*-->>?(\s|&nbsp;)*$/.test(a.last)&&a.pop();break}return a}function _repeatAndBreakPunchMerger(a,b,c,d){if(0===b.length)return;if(0===a.length)return void b.forEach(b=>a.push(b));d&&b.first===a.last&&b.shift();const e=a[a.length-1].trim(),f=b[0].trim(),g=e.length,h=e.charCodeAt(g-1);f.charCodeAt(0)!==rightQuote&&c(h,1<g?e.charCodeAt(g-2):null,2<g?e.charCodeAt(g-3):null)?(a[a.length-1]=e,a.push(f)):a[a.length-1]=e+f;for(let e=1;e<b.length;e++)a.push(b[e]);}function repeatMerger(a,b){if(0!==b.length){if(0===a.length)return void b.forEach(b=>a.push(b));a[a.length-1]!==b[0]&&a.push(b[0]);for(let c=1;c<b.length;c++)a.push(b[c]);}}function breakPunchMerger(a,b,c){_repeatAndBreakPunchMerger(a,b,c,!1);}function repeatAndBreakPunchMerger(a,b,c){_repeatAndBreakPunchMerger(a,b,c,!0);}function cleanContent(a){return a.map(a=>a.replace(/[\u200B-\u200F\uFEFF\u0300-\u036f]/g,"")).filter(a=>0<a.length)}function cleanContentAd(a){const b=/(?:请?退出转码页面，)?请下载.+ 阅读最新(?:章节|内容)。?/,c=/安卓、IOS版本请访问官网.+下载最新版本。如浏览器禁止访问，请换其他浏览器试试；如有异常请邮件反馈。/;for(let d=0;d<a.length;d++){if(/(推荐|讲真|话说).+(追[书更]|软件|app).+\w+\.\w+\.\w+/.test(a[d])){a.splice(d,1);break}if(b.test(a[d])){a[d]=a[d].replace(b,"").trim();break}if(c.test(a[d])){a[d]=a[d].replace(c,"").trim();break}}return a}function cleanContentRemember(a){return 2<a.length&&/^(?:[\s　]|&#?\w+;)*(?:请收藏本站|(?:(?:你是)?天才，?)?[一1]秒记住|请记住本书首发|喜欢.+请大家收藏).+([地网]址|\w+\.\w+\.\w+)/.test(a.last)&&(/https?:\/\//.test(a[a.length-2])?a.splice(a.length-2,2):a.splice(a.length-1,1)),a}function trimBeforeContent(a,b){const c=b instanceof RegExp?b:new RegExp(`(?:id|class)="${b}(?: [^"]*)?"[^>]*>`),d=c.exec(a);return d&&(a=a.substring(d.index+d[0].length)),a}function removeTrailingObfuscateTransformer(a){const b=a.split("\n");if(5<b.length)return a;if(2===b.length)return b[0];for(let c=1;c<b.length;c++)if(-1!==b[c].indexOf("\u7F51\u9875\u7248\u7AE0\u8282\u5185\u5BB9\u6162")||-1!==b[c].indexOf("\u8BF7\u9000\u51FA\u8F6C\u7801\u9875\u9762")){b.splice(c,b.length-c);break}return b.join("\n")}function removeTrailingNonContentTags(a){const b=/<\/?[ac-oq-z]+(?: [^>]*)?>/.exec(a);return b?a.substring(0,b.index):a}const paragraphContentRegexFragment="(?<fragment>(?:[^<]|<br\\s*\\/?>|<p[^>]*>|<\\/p>|<[^\\/a-zA-Z])*)",brContentRegexFragment="(?<fragment>(?:[^<]|<br\\s*\\/?>|<[^\\/a-zA-Z])*)";function parseWrapperRegex(a){if(null==a)return null;if(a instanceof RegExp)return {pattern:a};if("object"==typeof a)return a;if("div#content"===a)return {cleaner:a=>trimBeforeContent(a.replace(/id="content"[^>]*>(?:[^<]+最快更新<a[^>]+>[^<]+<\/a>最新章节！|\s*<p>[^<]+一秒记住[^<]+\w+\.\w+[^<]+最快更新[^<]+(?:<br\s*\/?>|\s)*<\/p>|[^<]+最快更新[^<]+！)/,"id=\"content\">"),/id="content(?: [^"]*)?"[^>]*>/)};if("div.content"===a)return {cleaner:a=>trimBeforeContent(a,/class="content(?: [^"]*)?"[^>]*>/)};if("div#BookText"===a)return {cleaner:a=>trimBeforeContent(a,"BookText")};if("div#booktxt"===a)return {cleaner:a=>trimBeforeContent(a,"booktxt")};if("div#htmlContent"===a)return {cleaner:a=>trimBeforeContent(a.replace(/id="htmlContent"[^>]*>[^<]+(<a[^>]+>[^<]+<\/a>(最新章节|[^<]*免费阅读)|最快更新[^<]+)！/,"id=\"htmlContent\">"),"htmlContent")};if("div.article-body>p"===a)return {cleaner:a=>trimBeforeContent(a,"article-body")};if("#chapter_content"===a)return {cleaner:a=>trimBeforeContent(a,/id=['"]chapter_content['"][^>]*>/)};if("#chaptercontent"===a)return {cleaner:a=>trimBeforeContent(a,"chaptercontent")};if("#txt"===a)return {cleaner:a=>trimBeforeContent(a,"txt")};if("#acontent"===a)return {cleaner:a=>trimBeforeContent(a,"acontent")};throw new Error(`unknown ParseContent wrapperRegex ${a}`)}function findNodeNameEnd(a,b){let d=a.charAt(b);if("/"===d&&(b+=1),d=a.charAt(b),!("a"<=d&&"z">=d||"A"<=d&&"Z">=d))return -1;for(let c=b+1;c<a.length;c++)if(d=a.charAt(c),!("a"<=d&&"z">=d||"A"<=d&&"Z">=d||"-"===d||"_"===d))return c;return -1}function collectLines(a,b){a=a.trim();let d,e,f=0;for(d=0;d<a.length;d++)if(e=a.charAt(d),"<"===e){const c=findNodeNameEnd(a,d+1);if(-1===c)continue;if(d>f){const c=a.substring(f,d).trim();0<c.length&&b.push(c);}let e=a.substring(d+("/"===a.charAt(d+1)?2:1),c).toLowerCase();if("br"===e||"p"===e){const b=a.indexOf(">",c);if(-1===b)return;if(f=b+1,d=b,"p"===e){let c=a.indexOf("</p>",b);if(-1===c&&(c=a.indexOf("</P>",b)),-1!==c&&/<a /i.test(a.substring(b,c)))return}}else return}if(d>f){const c=a.substring(f,d).trim();0<c.length&&b.push(c);}}async function extractFragment(a,b){let c;if(null==b)c=a;else if(c=null==b.pattern?a:b.pattern.exec(a).groups.fragment,null!=b.cleaner){c=b.cleaner(c);const{removeLeadingNonContentTags:a}=await require("transcode/utils");c=a(c),c=removeTrailingNonContentTags(c);}return c.trim()}async function parseContent(a,b,c){const d=[];c=c||{};const e={encoding:"utf-8",...c.clientOptions};let f;if(c.webview){const b=require("webview_fetch");f=await b(a,{mobile:1===e["x-mobile"]});}else {const b={url:a,...c.httpOptions},{send:d}=require("http");stat("request");let g=await d(b,e);if(stat("request"),c.onBlocked&&isBlocked(g))return c.onBlocked();if(null!=c.retry&&(g=await handleRequestRetry(g,b,e,d,c.retry)),c.fallbackToWebview&&c.fallbackToWebview(g)){const b=require("webview_fetch");f=await b(a,{mobile:1===e["x-mobile"],...c.webviewOptions});}else assertOK(g),f=g.body;}if(null!=c.preprocess&&(f=c.preprocess(f)),null!=c.parser)return c.parser(f);f=cleanHTML(f);let g=parseWrapperRegex(b);stat("fragment");let h=await extractFragment(f,g);if(stat("fragment"),null!=c.transformer){stat("transformer");const a=c.transformer(h);h=a instanceof Promise?await a:a,stat("transformer");}return stat("collect"),collectLines(h,d),stat("collect"),cleanContent(d)}async function parseContentPaginate(a,b,c){let d=1;const e=[];let f=!0;const g={encoding:"utf-8",...c.clientOptions};let h=parseWrapperRegex(b),i=c.pageCleaner||noopPageCleaner;const j=c.maxPage??10;do{if(d>j)break;const b=a(d);let k;if(c.webview){const a=require("webview_fetch");k=await a(b,{mobile:1===g["x-mobile"]});}else {const a={url:b,...c.httpOptions},{send:d}=require("http");stat("request");let e=await d(a,g);if(stat("request"),c.onBlocked&&isBlocked(e))return c.onBlocked();if(null!=c.retry&&(e=await handleRequestRetry(e,a,g,d,c.retry)),c.fallbackToWebview&&c.fallbackToWebview(e)){const a=require("webview_fetch");k=await a(b,{mobile:1===g["x-mobile"]});}else assertOK(e),k=e.body;}null!=c.preprocess&&(k=c.preprocess(k)),f=c.hasNextFn(k);let l;if(l=void 0===c.merger?breakPunchMerger:c.merger,null!=c.parser){const a=await c.parser(k);null==l?i(a instanceof Array?a:a.content).forEach(a=>e.push(a)):l(e,i(a instanceof Array?a:a.content),isBreakPunch);}else {k=cleanHTML(k);let a=await extractFragment(k,h);if(null!=c.transformer){const b=c.transformer(a);a=b instanceof Promise?await b:b;}if(l){const b=[];collectLines(a,b),l(e,i(b),isBreakPunch);}else collectLines(a,e);0!==c.delay&&(await delay(c.delay||200));}d++;}while(f);return cleanContent(e)}const htmlContent3DotsPaginateOptions={hasNextFn:a=>null!=/id="linkNext"[^>]+href="[^"]*\d+_\d+\.html"/.exec(a),transformer:a=>a.replace(/<p class="text-danger[^>]+>[^<]+<\/p>/,""),pageCleaner:a=>(0<a.length&&(a.last=a.last.replace(/\.\.\.\s*-->>\s*$/,"").trim()),a),merger:(a,b,c)=>{if(0<a.length&&0<b.length&&3<=a.last.length&&0<=b.first.length&&a.last.substring(a.last.length-3)===b.first.substring(0,3)){a.last+=b.first.substring(3),b.shift();for(let c of b)a.push(c);return}breakPunchMerger(a,b,c);}},googleAdPattern=/<div [^>]+google[^>]*>.+<\/div>|<p>\s*<a [^>]*>[^<]*<\/a>\s*<\/p>/g;exports.parseContent=parseContent,exports.parseContentPaginate=parseContentPaginate,exports.simpleMerger=simpleMerger,exports.repeatMerger=repeatMerger,exports.breakPunchMerger=breakPunchMerger,exports.repeatAndBreakPunchMerger=repeatAndBreakPunchMerger,exports.hasMorePageCleaner=hasMorePageCleaner,exports.cleanContent=cleanContent,exports.cleanContentAd=cleanContentAd,exports.cleanContentRemember=cleanContentRemember,exports.trimBeforeContent=trimBeforeContent,exports.removeTrailingNonContentTags=removeTrailingNonContentTags,exports.removeTrailingObfuscateTransformer=removeTrailingObfuscateTransformer,exports.collectLines=collectLines,exports.extractFragment=extractFragment,exports.paragraphContentRegexFragment=paragraphContentRegexFragment,exports.brContentRegexFragment=brContentRegexFragment,exports.googleAdPattern=googleAdPattern,exports.htmlContent3DotsPaginateOptions=htmlContent3DotsPaginateOptions;