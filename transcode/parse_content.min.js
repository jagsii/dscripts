const{send}=require("http"),breakPunchCodes=[12290,65281,65311,8221];function isBreakPunch(a,b,c){return 46===a&&46===b&&46===c||-1!==breakPunchCodes.indexOf(a)}function noopPageCleaner(a){return a}function repeatMerger(a,b){if(0!==b.length){if(0===a.length)return void b.forEach(b=>a.push(b));a[a.length-1]!==b[0]&&a.push(b[0]);for(let c=1;c<b.length;c++)a.push(b[c]);}}function cleanContent(a){return a.map(a=>a.replace(/[\u200B-\u200F\uFEFF\u0300-\u036f]/g,"")).filter(a=>0<a.length)}const paragraphContentRegexFragment="(?<fragment>(?:[^<]+|<br\\s*\\/?>|<p[^>]*>|<\\/p>|<[^\\/a-zA-Z])*)",brContentRegexFragment="(?<fragment>(?:[^<]+|<br\\s*\\/?>|<[^\\/a-zA-Z])*)";function parseWrapperRegex(a){if(null==a)return null;if(a instanceof RegExp)return a;if("div#content"===a)return /id="content"[^>]*>(?:\s*(?:<!--[\S\s]*?-->|<script>[\S\s]*?<\/script>|<div[^>]*>[\S\s]*?<\/div>|<a[^>]*>[\S\s]*?<\/a>)\s*(?:<br\s*\/?>)*)*(?<fragment>(?:[^<]+|<br\s*\/?>|<p[^>]*>|<\/p>|<[^\/a-zA-Z])*)</;if("div.content"===a)return /class="content"[^>]*>(?:\s*(?:<!--[\S\s]*?-->|<script>[\S\s]*?<\/script>|<div[^>]*>[\S\s]*?<\/div>|<a[^>]*>[\S\s]*?<\/a>)\s*(?:<br\s*\/?>)*)*(?<fragment>(?:<br\s*\/?>|<p[^>]*>|<\/p>|<[^\/a-zA-Z]|[^<]+)*)</;if("div#BookText"===a)return /<div id="BookText">(?:<!--.*?-->)*(?<fragment>(?:[^<]|<br\s*\/?>|<p>|<\/p>|<[^\/a-zA-Z])*)<\/div>/;if("div.article-body>p"===a)return /<div class="article-body" role="article-body">(?:(?:<div class="k"><\/div>)?(?:<div class="kk">(?:<script>.*?<\/script>)?<\/div>)?)?(?<fragment>(?:\s*<p>(?:[^<]|<[^\/a-zA-Z])*<\/p>\s*)+)/;if("div#chapter_content>p"===a)return /<div id="chapter_content">(?:<!--[^>]*-->)*(?<fragment>(?:\s*<p>(?:[^<]|<[^\/a-zA-Z])*<\/p>\s*)+)/;if("div#txt>p"===a)return /<div [^>]*id="txt"[^>]*>(?:<!--[^>]*-->)*(?<fragment>(?:\s*<p>(?:[^<]|<[^\/a-zA-Z])*<\/p>\s*)+)/;throw new Error(`unknown ParseContent wrapperRegex ${a}`)}function collectLines(a,b){a.split(/<[^<>]+>|\n/).forEach(a=>{a=a.trim(),0<a.length&&b.push(a);});}function simpleMerger(a,b){for(let d of b)a.push(d);}async function parseContent(a,b,c){const d=[];c=c||{};const e={url:a,...c.httpOptions},f={encoding:"utf-8",...c.clientOptions};let g;if(c.webview){const b=require("webview_fetch");g=await b(a,{mobile:1===f["x-mobile"]});}else {stat("request");let a=await send(e,f);if(stat("request"),null!=c.retry)for(let b=0;!0===(await c.retry(a,e,f,b))&&3>b++;)a=await send(e,f);if(200>a.statusCode||299<a.statusCode)throw new Error(`Request failed with statusCode ${a.statusCode}, ${a.reasonPhrase}`);g=a.body;}if(null!=c.preprocess&&(g=c.preprocess(g)),null!=c.parser)return c.parser(g);g=g.replace(/<a [^>]*>[^<]*<\/a>/g,"");let h=parseWrapperRegex(b);stat("fragment");let i=null==h?g:h.exec(g).groups.fragment;if(stat("fragment"),null!=c.transformer){stat("transformer");const a=c.transformer(i);i=a instanceof Promise?await a:a,stat("transformer");}return stat("collect"),collectLines(i,d),stat("collect"),cleanContent(d)}async function parseContentPaginate(a,b,c){let d=1;const e=[];let f=!0;const g={encoding:"utf-8",...c.clientOptions};let h=parseWrapperRegex(b),i=c.pageCleaner||noopPageCleaner;do{if(10<d)break;const b=a(d);let j;if(c.webview){const a=require("webview_fetch");j=await a(b,{mobile:1===g["x-mobile"]});}else {const a={url:b,...c.httpOptions};let d=await send(a,g);if(null!=c.retry)for(let b=0;!0===(await c.retry(d,a,g,b))&&3>b++;)d=await send(a,g);if(200>d.statusCode||299<d.statusCode)throw new Error(`Request failed with statusCode ${d.statusCode}, ${d.reasonPhrase}`);j=d.body;}null!=c.preprocess&&(j=c.preprocess(j)),f=c.hasNextFn(j),j=j.replace(/<a [^>]*>[^<]*<\/a>/g,"");let k;if(void 0===c.merger?k=(a,b,c)=>{if(0===b.length)return;if(0===a.length)return void b.forEach(b=>a.push(b));const d=a[a.length-1].trim(),e=b[0].trim(),f=d.length,g=d.charCodeAt(f-1);c(g,1<f?d.charCodeAt(f-2):null,2<f?d.charCodeAt(f-3):null)?(a[a.length-1]=d,a.push(e)):a[a.length-1]=d+e;for(let d=1;d<b.length;d++)a.push(b[d]);}:c.merger&&(k=c.merger),null!=c.parser){const a=c.parser(j);null==k?i(a instanceof Array?a:a.content).forEach(a=>e.push(a)):k(e,i(a instanceof Array?a:a.content),isBreakPunch);}else {let a=null==h?j:h.exec(j).groups.fragment;if(null!=c.transformer){const b=c.transformer(a);a=b instanceof Promise?await b:b;}if(k){const b=[];collectLines(a,b),k(e,i(b),isBreakPunch);}else collectLines(a,e);0!==c.delay&&(await delay(c.delay||200));}d++;}while(f);return cleanContent(e)}exports.parseContent=parseContent,exports.parseContentPaginate=parseContentPaginate,exports.simpleMerger=simpleMerger,exports.repeatMerger=repeatMerger,exports.cleanContent=cleanContent,exports.paragraphContentRegexFragment=paragraphContentRegexFragment,exports.brContentRegexFragment=brContentRegexFragment;