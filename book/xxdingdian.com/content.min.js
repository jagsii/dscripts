exports=async function(url,bid,cid,options){function bsf(){var _StringfromCharCode=String.fromCharCode;this.encode=function(a){var c,d,e,f,g,h,i,b="",j=0;for(a=_utf8_encode(a);j<a.length;)c=a.charCodeAt(j++),d=a.charCodeAt(j++),e=a.charCodeAt(j++),f=c>>2,g=(3&c)<<4|d>>4,h=(15&d)<<2|e>>6,i=63&e,isNaN(d)?h=i=64:isNaN(e)&&(i=64),b=b+_keyStr.charAt(f)+_keyStr.charAt(g)+_keyStr.charAt(h)+_keyStr.charAt(i);return b},this.decode=function(a){var c,d,e,f,g,h,i,b="",j=0;for(a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");j<a.length;)f=_keyStr.indexOf(a.charAt(j++)),g=_keyStr.indexOf(a.charAt(j++)),h=_keyStr.indexOf(a.charAt(j++)),i=_keyStr.indexOf(a.charAt(j++)),c=f<<2|g>>4,d=(15&g)<<4|h>>2,e=(3&h)<<6|i,b+=_StringfromCharCode(c),64!=h&&(b+=_StringfromCharCode(d)),64!=i&&(b+=_StringfromCharCode(e));return b=_utf8_decode(b)},_utf8_encode=function(a){var b,c,d;for(a=a.replace(/\r\n/g,"\n"),b="",c=0;c<a.length;c++)d=a.charCodeAt(c),128>d?b+=_StringfromCharCode(d):127<d&&2048>d?(b+=_StringfromCharCode(192|d>>6),b+=_StringfromCharCode(128|63&d)):(b+=_StringfromCharCode(224|d>>12),b+=_StringfromCharCode(128|63&d>>6),b+=_StringfromCharCode(128|63&d));return b},_utf8_decode=function(a){for(var b="",c=0,d=c1=c2=0;c<a.length;)d=a.charCodeAt(c),128>d?(b+=_StringfromCharCode(d),c++):191<d&&224>d?(c2=a.charCodeAt(c+1),b+=_StringfromCharCode((31&d)<<6|63&c2),c+=2):(c2=a.charCodeAt(c+1),c3=a.charCodeAt(c+2),b+=_StringfromCharCode((15&d)<<12|(63&c2)<<6|63&c3),c+=3);return b};}function parseFullContent(html,result){function Decode64(str){return decodeURIComponent(atob(str).split("").map(function(c){return "%"+("00"+c.charCodeAt(0).toString(16)).slice(-2)}).join(""))}const raw=html.subRegex(/var contentFull\s*=\s*'([^']+)'/),replaces=html.subRegexMapAll(/contentFull\.replace\(new RegExp\(Decode64\("(?<a>[^"]+)"\),'g'\),Decode64\("(?<b>[^"]+)"\)\)/g);let contentFull=Decode64(raw);for(let re of replaces)contentFull=contentFull.replace(new RegExp(Decode64(re.a),"g"),Decode64(re.b));collectLines(contentFull,result);}const{parseContentPaginate,collectLines}=await require("transcode/parse_content"),_keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";const{send}=require("http"),clientOptions={...(options&&options.clientOptions)},response=await send(url,clientOptions);assertOK(response);const html=response.body;if(/var contentFull\s*=\s*'([^']+)'/.test(html))return async function(html0){const result=[];parseFullContent(html0,result);for(let page=2;;){const response=await send(`https://www.xxdingdian.com/book/${bid}/${cid}_${page}.html`,clientOptions);assertOK(response);const html=response.body;if(parseFullContent(html,result),!/id="A3" href="\/book\/\d+\/\d+_\d+\.html"/.test(html)||20<page++)break}return result}(html);const args=html.subRegexMap(/get_contents\('(?<bid>\d+)','(?<cid>\d+)','(?<pid>\d+)','(?<page_count>\d+)','[^']*','[^']*','(?<type>[^']*)'\)/);if(!args)return null;const httpOptions={headers:{Accept:"text/javascript, application/javascript, application/x-javascript",Referer:url,"Content-Type":"application/x-www-form-urlencoded","x-requested-with":"XMLHttpRequest"},method:"POST",body:""},totalPages=parseInt(args.page_count);let hasNextPage=!1;return parseContentPaginate(page=>(hasNextPage=page<totalPages,httpOptions.body=`aid=${args.bid}&cid=${args.cid}&pid=${page}&page_count=${args.page_count}&getcontent=1&type=${args.type}`,httpOptions.headers.Referer=1===page?url:url.replace(".html",`_${page}.html`),`https://www.xxdingdian.com/report.php?_=${new Date().getTime()}`),"div#content",{httpOptions,clientOptions,hasNextFn:()=>hasNextPage,parser:html=>{let txt=html.subRegex(/var txt="([^"]+)"/);const replacements=html.subRegexMapAll(/\w+\.decode\("(?<s>[^"]+)"\),'g'\),\w+\.decode\("(?<r>[^"]+)"\)/g),_bsf=new bsf;txt=_bsf.decode(txt);for(let r of replacements)txt=txt.replace(new RegExp(_bsf.decode(r.s),"g"),_bsf.decode(r.r));return txt.split("<br>")}})};