String.prototype.matchAll||(String.prototype.matchAll=function(regexp){let match;const result=[];for(;null!==(match=regexp.exec(this));)result.push(match);return result[Symbol.iterator]()}),"undefined"==typeof globalThis&&("undefined"==typeof window?"undefined"==typeof global?"undefined"!=typeof self&&(self.globalThis=self):global.globalThis=global:window.globalThis=window),String.prototype.intValue||(String.prototype.intValue=function(){try{return parseInt(this)}catch(e){return null}}),String.prototype.subRegex||(String.prototype.subRegex=function(regex){const match=regex.exec(this);return null==match?null:match[1]}),String.prototype.subRegexFirst||(String.prototype.subRegexFirst=function(regex){const match=regex.exec(this);if(null==match)return null;for(let i=1;i<match.length;i++)if(match[i]!==void 0)return match[i];return null}),String.prototype.subRegexLast||(String.prototype.subRegexLast=function(regex){if(-1===regex.flags.indexOf("g"))throw "subRegexLast regex flag must include g";let match,validMatch;for(;null!==(match=regex.exec(this));)validMatch=match;return validMatch?validMatch[1]:null}),String.prototype.subRegexMapAll||(String.prototype.subRegexMapAll=function(regex){if(-1===regex.flags.indexOf("g"))throw "subRegexMapAll regex flag must include g";const result=[];for(let match;null!==(match=regex.exec(this));){let record;for(let key in match.groups)void 0!==match.groups[key]&&(void 0===record&&(record={}),record[key]=match.groups[key]);record!==void 0&&result.push(record);}return result}),String.prototype.subRegexAll||(String.prototype.subRegexAll=function(regex){if(-1===regex.flags.indexOf("g"))throw "subRegexAll regex flag must include g";const result=[];for(let match;null!==(match=regex.exec(this));)for(let i=1;i<match.length;i++)if(match[i]!==void 0){result.push(match[i]);break}return result}),String.prototype.subRegexMap||(String.prototype.subRegexMap=function(regex){const result={};if(-1===regex.flags.indexOf("g")){const m=regex.exec(this);if(null!=m)for(let key in m.groups)void 0!==m.groups[key]&&(result[key]=m.groups[key]);}else {const matches=this.matchAll(regex);for(let m of matches)for(let key in m.groups)if(m.groups[key]!==void 0){result[key]=m.groups[key];break}}return result}),String.prototype.contains||(String.prototype.contains=function(search){return -1!==this.indexOf(search)}),String.prototype.indexOfRegex||(String.prototype.indexOfRegex=function(search){const match=search.exec(this);return match?match.index:-1}),String.prototype.lastIndexOfRegex||(String.prototype.lastIndexOfRegex=function(search){let match,lastMatch;for(;null!==(match=search.exec(this));)lastMatch=match;return lastMatch?lastMatch.index:-1}),String.prototype.subIndexOf||(String.prototype.subIndexOf=function(search){if(search instanceof RegExp){const m=search.exec(this);return m?this.substring(m.index+m[0].length):this}const pos=this.indexOf(search);return -1===pos?this:this.substring(pos+search.length)}),String.prototype.subLastIndexOf||(String.prototype.subLastIndexOf=function(search){if(search instanceof RegExp){if(-1===search.flags.indexOf("g"))throw "subLastIndexOf regex flag must include g";let m,pos=-1;for(;null!=(m=search.exec(this));)pos=m.index+m[0].length;return -1===pos?this:this.substring(pos)}const pos=this.lastIndexOf(search);return -1===pos?this:this.substring(pos+search.length)}),String.prototype.toIndexOf||(String.prototype.toIndexOf=function(search){if(search instanceof RegExp){const m=search.exec(this);return m?this.substring(0,m.index):this}const pos=this.indexOf(search);return -1===pos?this:this.substring(0,pos)}),String.prototype.toLastIndexOf||(String.prototype.toLastIndexOf=function(search){const pos=this.lastIndexOf(search);return -1===pos?this:this.substring(0,pos)}),String.prototype.idPrefix||(String.prototype.idPrefix=function(){return 3<this.length?this.substring(0,this.length-3):"0"}),String.prototype.trimHTMLSpace||(String.prototype.trimHTMLSpace=function(){return trimHTMLSpace(this)}),Array.prototype.first||Object.defineProperty(Array.prototype,"first",{get(){return 0===this.length?void 0:this[0]},set(element){this[0]=element;},enumerable:!1}),Array.prototype.last||Object.defineProperty(Array.prototype,"last",{get(){return 0===this.length?void 0:this[this.length-1]},set(element){this[this.length-1]=element;},enumerable:!1}),globalThis.reverseRange=function(array,start,end){for(let i=start;i<end;i++){const swap=start+end-i-1;if(swap<=i)break;let tmp=array[i];array[i]=array[swap],array[swap]=tmp;}return array},globalThis.delay=async function(duration){return new Promise(resolve=>{setTimeout(()=>resolve(),duration);})},globalThis.stat===void 0&&(globalThis.stat=function(){}),globalThis.assertOK=function(response){if(200>response.statusCode||299<response.statusCode)throw new Error(`Request failed with statusCode ${response.statusCode}, ${response.reasonPhrase}`)},globalThis.isCloudFlareBlocked=function(response){return (403===response.statusCode||522===response.statusCode)&&null!=response.headers["cf-ray"]},globalThis.isBlocked=function(response){return 0===response.statusCode&&(-1!==response.reasonPhrase?.indexOf("Connection terminated during handshake")||-1!==response.reasonPhrase?.indexOf("Connection closed before full header was received"))},globalThis.handleRequestRetry=async function(response,httpOptions,clientOptions,send,retry){for(let count=0;!0===(await retry(response,httpOptions,clientOptions,count))&&3>count++;)response=await send(httpOptions,clientOptions);return response},globalThis.formatTags=function(raw){return raw.split(/[\s,]/).map(_=>_.trim()).filter(_=>0<_.length).join(",")},globalThis.cleanHTMLComments=function(html){return html.replace(/<!--[\S\s]*?-->/g,"")},globalThis.cleanHTMLScripts=function(html){return html.replace(/<script(?: [^>]+)?>(?:'[^']*'|"[^"]*"|<[^\/]|[^<'"])*<\/script>/ig,"")},globalThis.cleanHTML=function(html){return cleanHTMLScripts(cleanHTMLComments(html))},globalThis.Utils={getUrlPath(url){let result=url;(url.startsWith("http:")||url.startsWith("https:"))&&(result=url.substring(url.indexOf("/")));let p=result.indexOf("?");return -1!==p&&(result=result.substring(0,p)),p=result.indexOf("#"),-1!==p&&(result=result.substring(0,p)),result}};const itoc="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",ctoi={};for(let index=0;66>index;index++)ctoi[itoc.charAt(index)]=index;globalThis.atob=function(data){var _StringfromCharCode=String.fromCharCode;let chr,bs,string=(data+"").replace(/[\t\n\f\r ]+/g,""),output="",position=0,bc=0;if(0==string.length%4&&(string=string.replace(/[=]+$/,"")),1==string.length%4||/[^\d+/a-z]/i.exec(string))throw new Error("The string is not correctly encoded");for(;chr=string.charAt(position++);)ctoi.hasOwnProperty(chr)&&(bs=bc%4?64*bs+ctoi[chr]:ctoi[chr],bc++%4&&(output+=_StringfromCharCode(255&bs>>(6&-2*bc))));return output},globalThis.btoa=function(data){let block,charCode,string=data+"",output="",position=0,map=itoc;for(;string.charAt(position)||(map="=",position%1);){if(charCode=string.charCodeAt(position+=3/4),255<charCode)throw new Error("The string contains characters outside of the Latin1 range");block=block<<8|charCode,output+=map.charAt(63&block>>8-8*(position%1));}return output},globalThis.lvtCookie=function(key){const time=new Date().getTime().toString().substring(0,10);return `Hm_lvt_${key}=${time}; Hm_lpvt_${key}=${time}`},globalThis.getHtml=async function(url,clientOptions){const{send}=require("http"),response=await send(url,clientOptions);return assertOK(response),response.body};function calcAgoOffset(value){const match=/\s*-?([\d.]+)\s*个?([秒分钟小时天日周星期月年]+)\s*(?:[以之]?前)?\s*/.exec(value);if(null==match)return null;const num=parseFloat(match[1]),unit=match[2];let offset;switch(unit){case"\u79D2":offset=1e3*num;break;case"\u5206":case"\u5206\u949F":offset=6e4*num;break;case"\u65F6":case"\u5C0F\u65F6":offset=36e5*num;break;case"\u5929":case"\u65E5":offset=36e5*(24*num);break;case"\u5468":case"\u661F\u671F":offset=36e5*(24*(7*num));break;case"\u6708":offset=36e5*(24*(30*num));break;case"\u5E74":offset=36e5*(24*(365*num));break;default:return null;}return offset}function parseAgo(value){if("\u521A\u521A"==value)return new Date;const offset=calcAgoOffset(value);if(null==offset)return null;const now=new Date().getTime();return new Date(now-Math.trunc(offset))}function applyDateValue(date,map){if(map.y!==void 0){const y=parseInt(map.y);date.setFullYear(100>y?100*Math.trunc(date.getFullYear()/100)+y:y);}map.M!==void 0&&date.setMonth(parseInt(map.M)-1),map.d!==void 0&&date.setDate(parseInt(map.d)),date.setHours(map.H===void 0?0:parseInt(map.H),map.m===void 0?0:parseInt(map.m),map.s===void 0?0:parseInt(map.s)),-480!==date.getTimezoneOffset()&&date.setTime(date.getTime()+6e4*(-480+date.getTimezoneOffset()));}function tryParseDate(value){const dateMap=value.subRegexMap(/(?:(?<y>\d{2,4})[-\/年])?(?<M>\d{1,2})[-\/月](?<d>\d{1,2})/),timeMap=value.subRegexMap(/(?<H>\d{1,2})[:时](?<m>\d{1,2})(?:[:分](?<s>\d{1,2})?)?/),map={...dateMap,...timeMap};if(0<Object.keys(map).length){const date=new Date;return applyDateValue(date,map),date}return null}globalThis.parseDate=function(value,format){function isDigital(c){return 48<=c&&57>=c}value=value.trim();let result;if("timestamp"===format)return 13<value.length&&(value=value.substring(0,13)),13===value.length?new Date(parseInt(value)):10===value.length?new Date(1e3*parseInt(value)):null;if("ago"===format&&(result=parseAgo(value),result))return result;if(value.endsWith("\u524D"))return parseAgo(value);if(null==format||/(?:(?<y1>y{2,4})[-\/年])?(?<M1>M{1,2})[-\/月](?<d1>d{1,2})|(?<H1>H{1,2})[:时](?<m1>m{1,2})(?:[:分](?<s1>s{1,2})?)?/.test(format))return tryParseDate(value);const formatTokens=[];for(let m;null!=(m=/y{2,4}|M{1,2}|d{1,2}|H{1,2}|m{1,2}|s{1,2}/g.exec(format));)formatTokens.push({f:m[0],start:m.index});if(0===formatTokens.length)return null;let offset=0;const tokenMap={};for(let token of formatTokens){let start=token.start+offset;if(!isDigital(value.charCodeAt(start)))return null;if("y"===token.f.charAt(0)){tokenMap.y=value.substring(start,start+token.f.length).intValue();continue}1===token.f.length&&start+1<value.length?isDigital(value.charCodeAt(start+1))?(tokenMap[token.f.charAt(0)]=value.substring(start,start+2).intValue(),offset++):tokenMap[token.f.charAt(0)]=value.substring(start,start+1).intValue():tokenMap[token.f.charAt(0)]=value.substring(start,start+2).intValue();}if(0<Object.keys(tokenMap).length){const date=new Date;return applyDateValue(date,tokenMap),date}return null},globalThis.trimHTMLSpace=function(raw){return raw.replace(/^([\s　]|&(nb|e[nm]|num|punc|thin)sp(1[34])?;|&#160;|&#819[4-9];|<br\s*\/?>)+/i,"").replace(/([\s　]|&(nb|e[nm]|num|punc|thin)sp(1[34])?;|&#160;|&#819[4-9];|<br\s*\/?>)+$/,"")};function singlifySpace(value){return value.replace(/[\s　]+/g," ")}globalThis.formatInfo=function(value){const{unescape}=require("html");return value.name&&(value.name=singlifySpace(unescape(value.name)).trimHTMLSpace()),value.author&&(value.author=singlifySpace(unescape(value.author)).trimHTMLSpace()),value.intro&&(value.intro=unescape(value.intro.replace(/&amp;/g,"&")).trimHTMLSpace().replace(/[ 　\t]/g," ").replace(/\r|\\r|\\n|<\/?[bB][rR] ?\/?>|<\/?[pP][^>]*>|\s{2,}/g,"\n").split("\n").map(_=>_.trim()).filter(element=>0<element.length).join("\n")),value},globalThis.formatUpdate=function(value){if(value.name){const{unescape}=require("html");value.name=singlifySpace(unescape(value.name)).trimHTMLSpace();}return value},globalThis.formatVideoUpdate=function(value){if(0===value.updates.length)return value;const{unescape}=require("html");for(let r of value.updates)r.name&&(r.name=singlifySpace(unescape(r.name)).trimHTMLSpace());return value},globalThis.formatCatalog=function(value){function doFormatCatalog(catalog){for(let record of catalog)record.name&&(record.name=singlifySpace(unescape(record.name)).trimHTMLSpace()),record.volume&&(record.volume=singlifySpace(unescape(record.volume)).trimHTMLSpace());}const{unescape}=require("html");if(value instanceof Array)return doFormatCatalog(value),value;if(value.hasOwnProperty("catalog")&&value.catalog instanceof Array)return doFormatCatalog(value.catalog),value;if(value.hasOwnProperty("catalogs")&&value.catalogs instanceof Array){for(let route of value.catalogs)doFormatCatalog(route.catalog);return value}return value},globalThis.formatBookContent=function(value){const isArray=value instanceof Array,list=isArray?value:value.content;if(0===list.length)return value;const{unescape}=require("html"),result=[];for(let _ of list){let line=unescape(_.replace(/&amp;/g,"&")).replace(/(\w)[  　]{2,}(\w)/g,(s,m,n)=>m+" "+n).replace(/\r|<\/?[bB][rR] ?\/?>|<\/?[pP][^>]*>|[ 　\s]{2,}/g,"\n").replace(/[ 　]/g," ");if(-1===line.indexOf("\n"))line=line.trimHTMLSpace(),0<line.length&&result.push(line);else for(let __ of line.split("\n"))__=__.trimHTMLSpace(),0<__.length&&result.push(__);}return isArray?result:(value.content=result,value)};